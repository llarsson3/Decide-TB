---
title: "Decide-TB"
author: "Leyla Sophie Larsson"
date: '`r Sys.Date()`'
output:
  html_document:
    toc: true
    toc_depth: 2
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning=FALSE, fig.align = 'center')
# chunk options https://yihui.org/knitr/options/
```

```{r clear, include=FALSE}
rm(list = ls())
```

```{r rstan_options(auto_write = TRUE), include=FALSE}
# Import libraries

library(haven)
library(labelled)
library(foreign)
library(sjlabelled)
library(gtsummary)
library(naniar)
library(lubridate)
library(lisa)
library(ggpubr)
library(gt)
library(knitr)
library(tidyverse)
library(ggplot2)
library(ggforce)
library(ggdist)
library(gghalves)
library(magrittr)
library(RColorBrewer)

theme_set(theme_light(base_size = 9))
```

```{r macros}
# Directories
rapaeddir <- "/users/leylasophielarsson/Desktop/Studies/Decide-TB/Analysis/Data/RaPaed/"
projdir <- "/users/leylasophielarsson/Desktop/Studies/Decide-TB/Analysis/Code/TDA/"
setwd(projdir)
# Standard settings
dotsize <- 0.4 # Set dot size

```

### Aim

The aim of this file is to manipulate the available data to fit the variables we need to have per person to run through the WHO's treatment decision algorithms (TDA). The variables to be used for the TDA can be found in the *"Decide-TB_Codebook.xlsx"* file. This will be done separately per study before merging into one main dataset.

```{r, include=FALSE}
# Import data
rapaed <- read_dta(paste0(rapaeddir, "Der01_RefStandard_DTA.dta"))

# Unlabel
# This is useful for sorting this out https://www.pipinghotdata.com/posts/2020-12-23-leveraging-labelled-data-in-r/
rapaed <- rapaed %>%
    mutate_if(haven::is.labelled, haven::as_factor)
```

```{r cr_dictionaries}
## Make a dictionary for each of the dataframes so its searchable
dict_rapaed <- labelled::generate_dictionary(rapaed) %>% 
    rename("variable_orig" = variable)
```

```{r}
# Some variables are stored as characters so make sure to switch the ones used for the analysis to numeric
names <- c("rapaed")

for (i in names) {
  assign(i, type.convert(get(i), as.is = TRUE))
}
```

```{r}
# Generate a binary variable 
rapaed <- rapaed %>% mutate(BinaryResult = if_else(Xpert_pp==3 & (SampleType=="1. Spontaneous sputum" | SampleType=="2. Induced sputum" | SampleType=="4. NPA" | SampleType=="5. Other respiratory sample" | SampleType=="3. Gastric lavage"),  "MTB Positive", "MTB Negative"))
var_label(rapaed$BinaryResult) <- "PCR result, binary"
```

**Age-related variables**

```{r, include=TRUE}
# Three variables are to be created for Age
# Age (continuous but the range is from 0 to 10 years)
var_label(rapaed$age) <- "Age" 

# Age (categorized from < 2 and 2 - 10 years)
rapaed$age_cat <- cut(rapaed$age,
                 breaks=c(0,2,10,15),
                 labels=c('< 2 years', '2 - 10 years', '> 10 years'))
var_label(rapaed$age_cat) <- "Age, categories"
rapaed$age_cat <- factor(rapaed$age_cat, levels = c('< 2 years', '2 - 10 years', '> 10 years'))

# Age (categorized from < 2 months, 2 months to 5 years, 5 - 9 years and > 9 years)
rapaed$age_cat_ext <- cut(rapaed$age,
                 breaks=c(0,0.1667,5,9,15),
                 labels=c('< 2 months', '2 months to 5 years', '5 - 9 years', '> 9 years'))
var_label(rapaed$age_cat_ext) <- "Age, extended categories"
rapaed$age_cat_ext <- factor(rapaed$age_cat_ext, levels = c('< 2 months', '2 months to 5 years', '5 - 9 years', '> 9 years'))
```

**Sex**

```{r}
rapaed <- rapaed %>% mutate(sex=if_else(Gender=="1. Male", "Male", "Female"))
```

**Symptoms suggestive of TB related variables**

```{r, include=TRUE}
# Cough ≥ 2 weeks 
rapaed <- rapaed %>% mutate(cough_2weeks = if_else(cough_at_V1 == 1 & CoughDurDays >= 14,  "Yes", "No"))
var_label(rapaed$cough_2weeks) <- "Cough more than 2 weeks?"

# Weight loss 
rapaed <- rapaed %>% mutate(weightloss = if_else(weightloss_at_V1==1, "Yes", "No"))
var_label(rapaed$weightloss) <- "Weight loss?"

# Failure to thrive 
rapaed <- rapaed %>% mutate(failuretothrive = if_else(failttrhrive_at_V1 == 1,  "Yes", "No"))
var_label(rapaed$failuretothrive) <- "Failure to thrive?"

# Fever ≥ 2 weeks 
rapaed <- rapaed %>% mutate(fever_2weeks = if_else(fever_at_V1 == 1 & FeverDurDays >= 14,  "Yes", "No"))
var_label(rapaed$fever_2weeks) <- "Fever more than 2 weeks?"

# Lethargy 
rapaed <- rapaed %>% mutate(lethargy = if_else(fatig_at_V1 == 1,  "Yes", "No"))
var_label(rapaed$lethargy) <- "Lethargy?"

# Haemoptysis
rapaed <- rapaed %>% mutate(haemoptysis = if_else(haemopt_at_V1 == 1,  "Yes", "No"))
var_label(rapaed$haemoptysis) <- "Haemoptysis?"

# Night sweats 
rapaed <- rapaed %>% mutate(nightsweats = if_else(nightsw_at_V1 == 1,  "Yes", "No"))
var_label(rapaed$nightsweats) <- "Night sweats?"

# Swollen lymph nodes
rapaed <- rapaed %>% mutate(lymphnodes = case_when(
  (Q_304c1Dum3_Exm=="no" | is.na(Q_304c1Dum3_Exm)) & (Q_304d1_Exm=="1 cm to < 2 cm" | Q_304d1_Exm=="2 cm to < 3 cm" | Q_304d1_Exm=="Other" | Q_304d1_Exm == "≥ 3 cm") & (Q_304b1_Exm=="Axillar" | Q_304b1_Exm=="Cervical" | Q_304b1_Exm=="Submandibular") ~ "Yes"))
var_label(rapaed$lymphnodes) <- "Enlarged lymph nodes?" 

# Tachycardia  
rapaed <- rapaed %>% mutate(tachycardia = case_when(
        Q_203b_Exm > 160 & age_cat_ext == "< 2 months" ~ "Yes",
        Q_203b_Exm > 150 & age >= 0.1667 & age < 1 ~ "Yes",
        Q_203b_Exm > 140 & age >= 1 & age < 5 ~ "Yes",
        Q_203b_Exm > 120 & age > 5 ~ "Yes"))
var_label(rapaed$tachycardia) <- "Tachycardia?"

# Tachypnoea  
rapaed <- rapaed %>% mutate(tachypnoea = case_when(
        Q_204b_Exm > 60 & age_cat_ext == "< 2 months" ~ "Yes",
        Q_204b_Exm > 50 & age >= 0.1667 & age < 1 ~ "Yes",
        Q_204b_Exm > 40 & age >= 1 & age < 5 ~ "Yes",
        Q_204b_Exm > 30 & age > 5 ~ "Yes"))
var_label(rapaed$tachypnoea) <- "Tachypnoea?"

# TB contact in the last 24 months?
rapaed <- rapaed %>% mutate(TBContact = if_else(Q_301_Qes=="1. Yes", "Yes", "No"))
var_label(rapaed$TBContact) <- "TB contact?"

# Replace all missing to "No"
for (col in c("cough_2weeks", "TBContact", "tachypnoea", "tachycardia", "lymphnodes", "nightsweats", "lethargy", "haemoptysis", "fever_2weeks", "cough_2weeks", "failuretothrive", "weightloss")) {
  rapaed[is.na(rapaed[, col]), col] <- "No"
}
```

**HIV**

```{r}
# Overall HIV status
rapaed <- rapaed %>% mutate(hivstatus=if_else(HIVstatus_bin=="HIV negative", "HIV negative",
                                              if_else(HIVstatus_bin=="HIV positive", "HIV positive", "Unknown")))
var_label(rapaed$hivstatus) <- "Overall HIV status - tested and reported"

rapaed <- rapaed %>% mutate(artstatus = if_else(ART_initiated=="Receiving ART >1 month", "HIV pos already on ART", 
                                          if_else(ART_initiated=="ART naiv or on ART <1 month","Naive", "HIV pos not on ART")))

for (col in c("hivstatus")) {
  rapaed[is.na(rapaed[, col]), col] <- "Unknown"
}
```

**Severe acute malnutrition**

```{r}
rapaed <- rapaed %>% mutate(sam = if_else(SAM_V1 == 1,  "Yes", "No"))
rapaed$sam[is.na(rapaed$sam)] <- "No"
var_label(rapaed$sam) <- "Severe acute malnutrition"
```

**Danger signs**

```{r}
# Danger signs - binary
# rapaed <- rapaed %>% mutate(dangersigns = if_else(Crit_ill == 1,  "Yes", "No"))
rapaed <- rapaed %>% mutate(dangersigns = "No")
var_label(rapaed$dangersigns) <- "Does the child show any danger signs?"
```

*mWRD*

```{r}
# Was a respiratory sample, stool sample, or urine sample collected for mWRD?
rapaed <- rapaed %>% mutate(sample = if_else(!is.na(BinaryResult),  "Yes", "No"))
var_label(rapaed$sample) <- "Was a respiratory sample, stool sample, or urine sample collected for mWRD?"

# What is the Xpert result?
rapaed <- rapaed %>% mutate(Xpert_result = if_else(BinaryResult == "MTB Positive",  "MTB Positive", "MTB Negative"))
var_label(rapaed$Xpert_result) <- "What is the Mtb Xpert result?"

# What is the Mtb final result?
rapaed <- rapaed %>% mutate(MTb_result = if_else(BinaryResult == "MTB Positive",  "MTB Positive", "MTB Negative"))
var_label(rapaed$MTb_result) <- "What is the Mtb final result?"

# Replace all missing to "No"
for (col in c("MTb_result")) {
  rapaed[is.na(rapaed[, col]), col] <- "MTB Negative"
}
```

*Chest X-Rays*

```{r}
# Cavities 
rapaed <- rapaed %>% mutate(CXR_cavitations = if_else(XryCavit==1,6,0))
var_label(rapaed$CXR_cavitations) <- "Did the chest X-ray show signs of cavitations?"

# Enlarged lymph nodes
rapaed <- rapaed %>% mutate(CXR_lymph = if_else(XryLobes==1,17,0))
var_label(rapaed$CXR_lymph) <- "Did the chest X-ray show signs of lymphadenopathy?"

# Opacities 
rapaed <- rapaed %>% mutate(CXR_opacity = if_else(XryOpac==1,5,0))
var_label(rapaed$CXR_opacity) <- "Did the chest X-ray show signs of opacities?"

# Miliary pattern 
rapaed <- rapaed %>% mutate(CXR_miliary = if_else(XryMiliary==1,15,0))
var_label(rapaed$CXR_miliary) <- "Did the chest X-ray show signs of miliary patterns?"

# Effusion 
rapaed <- rapaed %>% mutate(CXR_effusion = if_else(XryEffusion==1,8,0))
var_label(rapaed$CXR_effusion) <- "Did the chest X-ray show signs of effusion?"

# Replace all to zero if missing. 
for (col in c("CXR_effusion", "CXR_miliary", "CXR_lymph", "CXR_cavitations","CXR_opacity")) {
  rapaed[is.na(rapaed[, col]), col] <- 0
}
```

### Generate Decide-TB specific dataframes and save them for later use 

```{r}
# First generate study-identifiers
rapaed <- rapaed %>% mutate(
  study = case_when(!is.na(PersID) ~ "RaPaed"),
  id = PersID)
var_label(rapaed$study) <- "Which study does the data originate from?"

# Generate high risk group (< 2 years, CLHIV, SAM)
rapaed <- rapaed %>% mutate(highrisk = case_when(
        age < 2 | hivstatus == "Positive" | sam == "Yes" ~ "Yes",
        age >= 2 & (hivstatus != "Positive" | is.na(hivstatus)) & (sam != "Yes" | is.na(sam)) ~ "No"))
var_label(rapaed$highrisk) <- "High risk group (< 2 years, CLHIV, SAM)?"
```

```{r}
# Treatment initiation
rapaed <- rapaed %>% mutate(
  Treatment = if_else(is.na(TB_treat), "No", "Yes"))
var_label(rapaed$Treatment) <- "Treatment initiation?"
```

```{r}
rapaed <- subset(rapaed, EPTB==0 | is.na(EPTB))
```

```{r}
# Variable if CXR was done
rapaed <- rapaed %>% mutate(
  CXR_Done = if_else(is.na(XryFinding), "Missing", "CXR done"),
  Type = "Tertiary")
```

```{r}
rapaed <- rapaed[,c("study","id","age","age_cat","age_cat_ext","sex","Type","highrisk","TBContact","hivstatus","artstatus","sam","dangersigns","DiagnClass_TDA","Treatment","cough_2weeks","weightloss","fever_2weeks","lethargy","haemoptysis","nightsweats","lymphnodes","tachycardia","tachypnoea","CXR_cavitations","CXR_lymph","CXR_opacity","CXR_miliary","CXR_effusion","sample","Xpert_result","MTb_result","BinaryResult","CXR_Done")]
```

```{r}
# Save for later use
save(rapaed,file="/users/leylasophielarsson/Desktop/Studies/Decide-TB/Analysis/Data/Decide-TB_RaPaedDataset.Rda")
save(dict_rapaed,file="/users/leylasophielarsson/Desktop/Studies/Decide-TB/Analysis/Data/Decide-TB_RaPaedDict.Rda")
```

