---
title: "Decide-TB"
author: "Leyla Sophie Larsson"
date: '`r Sys.Date()`'
output:
  html_document:
    toc: true
    toc_depth: 2
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning=FALSE, fig.align = 'center')
# chunk options https://yihui.org/knitr/options/
```

```{r clear, include=FALSE}
rm(list = ls())
```

```{r rstan_options(auto_write = TRUE), include=FALSE}
# Import libraries

library(haven)
library(labelled)
library(foreign)
library(sjlabelled)
library(gtsummary)
library(naniar)
library(lubridate)
library(lisa)
library(ggpubr)
library(gt)
library(knitr)
library(tidyverse)
library(ggplot2)
library(ggforce)
library(ggdist)
library(gghalves)
library(magrittr)
library(multipanelfigure)
library(RColorBrewer)

theme_set(theme_light(base_size = 9))
```

```{r macros}
# Directories
projdir <- "/users/leylasophielarsson/Desktop/Studies/Decide-TB/Analysis/Code/TDA/PAANTHER/"
datadir <- "/users/leylasophielarsson/Desktop/Studies/Decide-TB/Analysis/Data/"
setwd(datadir)
# Standard settings
dotsize <- 0.4 # Set dot size

```

### Aim

The aim of this file is to manipulate the available data to fit the variables we need to have per person to run through the TB-Speed PAANTHER algorithm. 
![PAANTHER treatment decision algorithm](PAANTHER_algorithm.png)
#### RaPaed

```{r, include=FALSE}
# Import data
rapaed <- read_dta(paste0(datadir, "Der01_RefStandard_all.dta"))
rapaed_tblab <- read_dta(paste0(datadir, "DerA04_TbLabs.dta"))

# Unlabel
# This is useful for sorting this out https://www.pipinghotdata.com/posts/2020-12-23-leveraging-labelled-data-in-r/
rapaed <- rapaed %>%
    mutate_if(haven::is.labelled, haven::as_factor)
rapaed_tblab <- rapaed_tblab %>%
    mutate_if(haven::is.labelled, haven::as_factor)
```

```{r cr_dictionaries}

## Make a dictionary for each of the dataframes so its searchable
dict_rapaed <- labelled::generate_dictionary(rapaed) %>% 
    rename("variable_orig" = variable)
dict_rapaed_tblab <- labelled::generate_dictionary(rapaed_tblab) %>% 
    rename("variable_orig" = variable)

```

```{r}
# Some variables are stored as characters so make sure to switch the ones used for the analysis to numeric
names <- c("rapaed", "rapaed_tblab")

for (i in names) {
  assign(i, type.convert(get(i), as.is = TRUE))
}
```

This is generating the TB Labs MAX result

```{r}
# Generate an overall TB lab result before collapsing 
library(dplyr)

# Define the order of diagnostic test results
result_order <- c("Not done","Trace", "Very low", "Low", "Medium", "High")

rapaed <- rapaed %>% mutate(PCR_Semiquant = case_when(
  Xpert_quant_pp == "1. Trace" ~ "Trace",
  Xpert_quant_pp == "2. Very Low" ~ "Very low",
  Xpert_quant_pp == "3. Low" ~ "Low",
  Xpert_quant_pp == "4. Medium" ~ "Medium",
  Xpert_quant_pp == "5. High" ~ "High"
))

# Convert the DiagnosticResult column to an ordered factor
rapaed$PCR_Semiquant[is.na(rapaed$PCR_Semiquant)] <- "Not done"
rapaed$PCR_Semiquant <- factor(rapaed$PCR_Semiquant, levels = result_order, ordered = TRUE)

```

```{r}
# Generate a binary variable 
rapaed <- rapaed %>% mutate(BinaryMaxResult = if_else(Xpert_pp==3,  "MTB Positive", "MTB Negative"))
var_label(rapaed$BinaryMaxResult) <- "PCR result, binary"
```

This is generating the TB Labs first result

```{r}
# Generate a binary variable 
rapaed <- rapaed %>% mutate(BinaryFirstResult = if_else(FirstSample_Ultra_Resp==1,  "MTB Positive", "MTB Negative"))
var_label(rapaed$BinaryFirstResult) <- "PCR result, binary"
```

**PAANTHER**

```{r, include=TRUE}
# Age (continuous but the range is from 0 to 14 years)
var_label(rapaed$age) <- "Age"

# Age (categorized from < 2 and 2 - 10 years)
rapaed$age_cat <- cut(rapaed$age,
                 breaks=c(0,2,10,15),
                 labels=c('< 2 years', '2 - 10 years', '> 10 years'))
var_label(rapaed$age_cat) <- "Age, categories"

```

```{r}
# Clinical suspicion of TB in an HIV-infected child
# Overall HIV status
rapaed$hivstatus <- rapaed$HIVstatus_bin 
var_label(rapaed$hivstatus) <- "Overall HIV status - tested and reported"

# Cough > 2 weeks
rapaed <- rapaed %>% mutate(Susp_Cough = if_else(cough_at_V1 == 1 & CoughDurDays >= 14,  "Yes", "No"))
var_label(rapaed$Susp_Cough) <- "Cough more than 2 weeks?"

# Fever > 2 weeks
rapaed <- rapaed %>% mutate(Susp_Fever = if_else(fever_at_V1 == 1 & FeverDurDays >= 14,  "Yes", "No"))
var_label(rapaed$Susp_Fever) <- "Fever more than 2 weeks?"

# Deviation in the growth curve or WAZ < -2SD
rapaed <- rapaed %>% mutate(Susp_Weight = if_else((zwamerge1 < -2), "Yes", "No"))
var_label(rapaed$Susp_Weight) <- "Weight loss?"

# Failure of antibiotics for a pulmonary infection ???

# Suggestive chest radiography
rapaed <- rapaed %>% mutate(Susp_Chest = case_when(
        Q_103_Xry == "1. Normal"  ~ "No",
        Q_103_Xry == "2. Findings attributable to TB"  ~ "Yes",
        Q_103_Xry == "3. Findings unlikely TB"  ~ "No"))
var_label(rapaed$Susp_Chest) <- "Chest X-Ray suggestive of TB?"

```


```{r}
# History of a contact with a TB case
rapaed <- rapaed %>% mutate(TBcontact = if_else((Q_301_Qes == "1. Yes") & (Q_301c1_Qes == "1. Sputum smear positive"),  "Yes", "No"))
var_label(rapaed$TBcontact) <- "History of a contact with a smear positive TB case?"

# Score: History of a contact with a TB case
rapaed <- rapaed %>% mutate(TBcontact_Score = if_else(TBcontact == "Yes",  118, 0))
var_label(rapaed$TBcontact_Score) <- "History of a contact with a smear positive TB case? -- score"
```


```{r}
# Detailed assessment of symptoms -- no time aspect

# Cough (unremitting???)
rapaed <- rapaed %>% mutate(Symp_Cough = if_else(cough_at_V1 == 1,  "Yes", "No"))
var_label(rapaed$Symp_Cough) <- "Cough?"

rapaed <- rapaed %>% mutate(Symp_Cough_Score = if_else(Symp_Cough == "Yes",  39, 0))
var_label(rapaed$Symp_Cough_Score) <- "Cough (unremitting)  -- score"

# Fever > 2 weeks
rapaed <- rapaed %>% mutate(Symp_Fever = if_else(fever_at_V1 == 1 & FeverDurDays >= 14,  "Yes", "No"))
var_label(rapaed$Symp_Fever) <- "Fever > 2 weeks?"

rapaed <- rapaed %>% mutate(Symp_Fever_Score = if_else(Symp_Fever == "Yes",  66, 0))
var_label(rapaed$Symp_Fever_Score) <- "Fever > 2 weeks -- score"

# Haemoptysis in last 4 weeks
rapaed <- rapaed %>% mutate(Symp_Haemo = if_else(haemopt_at_V1 == 1,  "Yes", "No"))
var_label(rapaed$Symp_Haemo) <- "Haemoptysis?"

rapaed <- rapaed %>% mutate(Symp_Haemo_Score = if_else(Symp_Haemo == "Yes",  79, 0))
var_label(rapaed$Symp_Haemo_Score) <- "Haemoptysis -- score"

# Weight loss in the last 4 weeks
rapaed <- rapaed %>% mutate(Symp_Weight = if_else((zwl_BMI1 < -2) | (zwamerge1 < -2), "Yes", "No"))
var_label(rapaed$Symp_Weight) <- "Weight loss?"

rapaed <- rapaed %>% mutate(Symp_Weight_Score = if_else(Symp_Weight == "Yes",  24, 0))
var_label(rapaed$Symp_Weight_Score) <- "Weight loss -- score"

# Tachycardia 
rapaed <- rapaed %>% mutate(Symp_Tachy = case_when(
        Q_203b_Exm > 160 & age_cat_ext == "< 2 months" ~ "Yes",
        Q_203b_Exm > 150 & age >= 0.1667 & age < 1 ~ "Yes",
        Q_203b_Exm > 140 & age >= 1 & age < 5 ~ "Yes",
        Q_203b_Exm > 120 & age > 5 ~ "Yes"))
var_label(rapaed$Symp_Tachy) <- "Tachycardia?"

rapaed <- rapaed %>% mutate(Symp_Tachy_Score = if_else(Symp_Tachy == "Yes", 54, 0))
var_label(rapaed$Symp_Tachy_Score) <- "Tachycardia -- score"


# Replace all to zero if missing. 
for (col in c("Symp_Cough_Score","Symp_Haemo_Score","Symp_Fever_Score","Symp_Weight_Score","Symp_Tachy_Score")) {
  rapaed[is.na(rapaed[, col]), col] <- 0
}
```

```{r}
# Score calculations
rapaed <- rapaed %>% mutate(Symp_Score = Symp_Cough_Score + Symp_Haemo_Score + Symp_Fever_Score + Symp_Weight_Score + Symp_Tachy_Score)
var_label(rapaed$Symp_Score) <- "Score of the signs and symptoms"

# Score cutoff 
rapaed <- rapaed %>% mutate(Symp_Score_Bin = case_when(
        Symp_Score > 100  ~ "Yes",
        Symp_Score <= 100 ~ "No" ))
var_label(rapaed$Symp_Score_Bin) <- "Score of the signs and symptoms, binary"
```

```{r}
# Chest radiograph 
# Enlarged lymph nodes
rapaed <- rapaed %>% mutate(CXR_lymph = if_else(Q_303d_Xry == "1. Yes" | Q_203d_Xry == "1. Yes" | Q_103d_Xry == "1. Yes",100,0))
var_label(rapaed$CXR_lymph) <- "Did the chest X-ray show signs of lymphadenopathy?"

# Opacities
rapaed <- rapaed %>% mutate(CXR_opacity = if_else(Q_103a_Xry == "1. Yes" | Q_203a_Xry == "1. Yes" | Q_303a_Xry == "1. Yes" | Q_103b_Xry == "1. Yes" | Q_203b_Xry == "1. Yes" | Q_303b_Xry == "1. Yes",74,0))
var_label(rapaed$CXR_opacity) <- "Did the chest X-ray show signs of opacities?"

# Miliary 
rapaed <- rapaed %>% mutate(CXR_miliary = if_else(Q_303e_Xry == "1. Yes" | Q_203e_Xry == "1. Yes" | Q_103e_Xry == "1. Yes",90,0))
var_label(rapaed$CXR_miliary) <- "Did the chest X-ray show signs of miliary patterns?"

# Replace all to zero if missing. 
for (col in c("CXR_miliary", "CXR_lymph", "CXR_opacity")) {
  rapaed[is.na(rapaed[, col]), col] <- 0
}
```

```{r}
# Xpert
# What is the Xpert result?
rapaed <- rapaed %>% mutate(MTb_result_max = if_else(BinaryMaxResult == "MTB Positive",  "MTB Positive", "MTB Negative"))
var_label(rapaed$MTb_result_max) <- "What is the Mtb Xpert result?"

rapaed <- rapaed %>% mutate(MTb_result_max_Score = if_else(MTb_result_max == "MTB Positive", 241, 0))
var_label(rapaed$MTb_result_max_Score) <- "Mtb result max -- score"

rapaed <- rapaed %>% mutate(MTb_result_first = if_else(BinaryFirstResult == "MTB Positive",  "MTB Positive", "MTB Negative"))
var_label(rapaed$MTb_result_first) <- "What is the Mtb Xpert result?"

rapaed <- rapaed %>% mutate(MTb_result_first_Score = if_else(MTb_result_first == "MTB Positive", 241, 0))
var_label(rapaed$MTb_result_first_Score) <- "Mtb result first -- score"

```

```{r}
# Nothing abdominal US
```

```{r}
# Score calculations
rapaed <- rapaed %>% mutate(Overall_Score_max = MTb_result_max_Score + CXR_lymph + CXR_opacity + CXR_miliary)
var_label(rapaed$Overall_Score_max) <- "Overall score"

# Score cutoff 
rapaed <- rapaed %>% mutate(Tx_Initiation_max = case_when(
        Overall_Score_max > 100  ~ "Initiate treatment",
        Overall_Score_max <= 100 ~"No treatment initiation"))
var_label(rapaed$Tx_Initiation_max) <- "Treatment initiation"

# Score calculations
rapaed <- rapaed %>% mutate(Overall_Score_first = MTb_result_first_Score + CXR_lymph + CXR_opacity + CXR_miliary)
var_label(rapaed$Overall_Score_first) <- "Overall score"

# Score cutoff 
rapaed <- rapaed %>% mutate(Tx_Initiation_first = case_when(
        Overall_Score_first > 100  ~ "Initiate treatment",
        Overall_Score_first <= 100 ~"No treatment initiation"))
var_label(rapaed$Tx_Initiation_first) <- "Treatment initiation"
```

```{r}
tbspeed_hiv <- rapaed
var_label(tbspeed_hiv$PersID) <- "Participant ID"

dict_tbspeed_hiv <- labelled::generate_dictionary(tbspeed_hiv) %>% 
    rename("variable_orig" = variable)
```

```{r}
# Add unclassifiable label to DiagnClass
tbspeed_hiv <- tbspeed_hiv %>% mutate(DiagnClass = if_else(is.na(DiagnClass),"Unclassifiable",DiagnClass))
```

```{r}
# Save for later use
save(tbspeed_hiv,file="/Users/leylasophielarsson/Desktop/Studies/Decide-TB/Analysis/Data/Decide-TB_HIV_Dataset.Rda")
save(dict_tbspeed_hiv,file="/Users/leylasophielarsson/Desktop/Studies/Decide-TB/Analysis/Data/Decide-TB_HIV_Dict.Rda")

```











