---
title: "Decide-TB - TDA A"
author: "Leyla Sophie Larsson"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: yes
    toc_depth: 4
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning=FALSE, fig.align = 'center')
# chunk options https://yihui.org/knitr/options/
```

```{r clear, include=FALSE}
rm(list = ls())
```

```{r rstan_options(auto_write = TRUE), include=FALSE}
# Import libraries

library(haven)
library(foreign)
library(gtsummary)
library(naniar)
library(lubridate)
library(lisa)
library(ggpubr)
library(gt)
library(knitr)
library(tidyverse)
library(ggplot2)
library(RColorBrewer)
library(hrbrthemes)

theme_set(theme_light(base_size = 9))
pal <- c("#FFA726","#EF6C00","#FFCC80","#FB8C00","#FFE0B2")
pal_b <- c("#64B5F6","#1565C0","#90CAF9","#2196F3","#BBDEFB")
pal_alpha <- c("#FFA72680","#EF6C0080","#FFCC8080","#FB8C0080","#FFE0B280")
pal_b_alpha <- c("#64B5F680","#1565C080","#90CAF980","#2196F380","#BBDEFB80")
pal_union <- c("#fcbc2a","#bc232c","#dc762c","#d15b2c","#FFCC80")
pal_union_b <- c("#1c3c73","#7388a7","#8ca4bc","#516b94","#cad2de")
pal_union_alpha <- c("#fcbc2a80","#bc232c80","#dc762c80","#d15b280c","#FFCC8800")
pal_union_b_alpha <- c("#1c3c7380","#7388a780","#8ca4bc80","#516b9480","#cad2d80e")

```

```{r macros}
# Directories
projdir <- "/Users/lshlf15/Library/CloudStorage/OneDrive-LondonSchoolofHygieneandTropicalMedicine/Studies/Decide-TB/Analysis/Code/TDA/WHO/"
datadir <- "/Users/lshlf15/Library/CloudStorage/OneDrive-LondonSchoolofHygieneandTropicalMedicine/Studies/Decide-TB/Analysis/Data/"
setwd(projdir)
# Standard settings
dotsize <- 0.4 # Set dot size
```

```{r, include=FALSE}
# Import data
load("/Users/lshlf15/Library/CloudStorage/OneDrive-LondonSchoolofHygieneandTropicalMedicine/Studies/Decide-TB/Analysis/Data/Decide-TB_Dataset.Rda")
load("/Users/lshlf15/Library/CloudStorage/OneDrive-LondonSchoolofHygieneandTropicalMedicine/Studies/Decide-TB/Analysis/Data/Decide-TB_DatasetDict.Rda")
```

```{r}
# Generate CD and CRS variables for later
decide <- decide %>% mutate(CD = case_when(
  Treatment == "Yes" ~ 1,
  Treatment == "No" ~ 0
))

decide <- decide %>% mutate(CRS = case_when(
  DiagnClass_TDA == "Confirmed TB" | DiagnClass_TDA == "Unconfirmed TB" | DiagnClass_TDA == "Confirmed" | DiagnClass_TDA == "Unconfirmed" ~ 1,
  DiagnClass_TDA == "Unlikely TB" | DiagnClass_TDA == "Unlikely" ~ 0),
  Outcome = if_else(CRS==1, "Children with TB*", "Children without TB*"))
```

```{r}
# Create variables to help reduce clutter
decide$age_cat_ext2 <- cut(decide$age,
                 breaks=c(0,2,5,10,15),
                 labels=c('< 2 years', '2 - < 5 years', '5 - 10 years', '> 10 years'))
decide$age_cat_ext2 <- factor(decide$age_cat_ext2, levels = c('< 2 years', '2 - < 5 years', '5 - 10 years', '> 10 years'))

# Data manipulation
decide <- decide %>% mutate(
  Normal = if_else(CXR_Normal == 1 , "Yes", "No"),
  Cavitations = if_else(CXR_cavitations > 0, "Yes", "No"),
  Adenopathy = if_else(CXR_lymph > 0, "Yes", "No"),
  Miliary = if_else(CXR_miliary > 0, "Yes", "No"),
  Opacities = if_else(CXR_opacity > 0, "Yes", "No"),
  Effusion = if_else(CXR_effusion > 0, "Yes", "No")
)

# Create sub datasets with restrictions
decide <- subset(decide, dangersigns == "No")
decide$DiagnClass_TDA <- factor(decide$DiagnClass_TDA, levels = c("Confirmed TB","Unconfirmed TB", "Unlikely TB"))
decide <- decide %>% mutate(Sum_required = if_else(TBContact == "No" & dangersigns == "No" & (MTb_result == "MTB Negative" | is.na(MTb_result)),  "Yes", "No"))

less2 <- subset(decide, age_cat == "< 2 years")
twoto5 <- subset(decide, age_cat_ext2 == "2 - < 5 years")
fiveto10 <- subset(decide, age_cat_ext2 == "5 - 10 years")
sub10 <- subset(decide, age_cat == "< 2 years" | age_cat == "2 - 10 years")

rapaed_sub10 <- subset(sub10, study=="RaPaed")
umoya_sub10 <- subset(sub10, study=="UMOYA")
hiv_sub10 <- subset(sub10, study=="HIV")
cohort_sub10 <- subset(sub10, study=="Cohort")

highrisk <- subset(sub10, highrisk=="Yes")
lowrisk <- subset(sub10, highrisk=="No")
```

Remove 80% of the low risk who are unlikely TB

```{r}
set.seed(1234)

subset_indices <- which(sub10$highrisk == "No" & sub10$DiagnClass_TDA == "Unlikely TB")
rows_to_remove <- sample(subset_indices, size = floor(0.8 * length(subset_indices)))
#sub10 <- sub10[-rows_to_remove, ]
#table(sub10$highrisk, sub10$DiagnClass_TDA)
```

### Table 1:  Socio-demographic and clinical characteristics of children included in the IPD by study

```{r}
library(htmlTable)
library(Gmisc)
library(stringi)
library(Hmisc)

sub10 %>%
  dplyr::rename("Study" = study,
                "Age" = age,
                "Age (categories)" = age_cat_ext2,
                "Sex" = sex,
                "HIV status" = hivstatus,
                "Severe acute malnutrition" = sam,
                "Case definition" = DiagnClass_TDA,
                "Treated for TB" = Treatment,
                "TB contact" = TBContact,
                "Cough ≥2 weeks" = cough_2weeks,
                "Fever ≥2 weeks" = fever_2weeks,
                "Weight loss" = weightloss,
                "Lethargy" = lethargy,
                "Haemoptysis" = haemoptysis,
                "Night sweats" = nightsweats,
                "Enlarged lymph nodes" = lymphnodes,
                "Tachycardia" = tachycardia,
                "Tachypnoea" = tachypnoea,
                "Miliary pattern" = Miliary,
                "Pleural effusion" = Effusion) %>%
  Gmisc::getDescriptionStatsBy("Age",
                               "Age (categories)",
                               "Sex",
                               "Normal",
                               "HIV status",
                               "Severe acute malnutrition",
                               "Case definition",
                               "Type",
                               "Treated for TB",
                               "TB contact",
                               "Cough ≥2 weeks",
                               "Fever ≥2 weeks",
                               "Weight loss",
                               "Lethargy",
                               "Haemoptysis",
                               "Night sweats",
                               "Enlarged lymph nodes",
                               "Tachycardia",
                               "Tachypnoea",
                               "Cavitations",
                               "Adenopathy",
                               "Opacities",
                               "Miliary pattern",
                               "Pleural effusion",
                               by = "Study", add_total_col = TRUE, hrzl_prop = FALSE, total_col_show_perc = TRUE, 
                               show_all_values = TRUE,
                               continuous_fn = describeMedian,
                               header_count = TRUE,
                               statistics = getPvalChiSq) %>%
  htmlTable::htmlTable(caption = "Sociodemographic characteristics by study",
                       align = "center", width = "100%") %>%
  addHtmlTableStyle(css.cell = "padding-left: .9em; padding-right: .9em;",
                    css.header = "font-weight: normal")
```

```{r}
library(htmlTable)
library(Gmisc)
library(stringi)
library(Hmisc)

sub10 %>%
  dplyr::rename("Study" = study,
                "Age" = age,
                "Age (categories)" = age_cat_ext2,
                "HIV status" = hivstatus,
                "Severe acute malnutrition" = sam,
                "Case definition" = DiagnClass_TDA,
                "Treated for TB" = Treatment,
                "TB contact" = TBContact,
                "Cough ≥2 weeks" = cough_2weeks,
                "Fever ≥2 weeks" = fever_2weeks,
                "Weight loss" = weightloss,
                "Lethargy" = lethargy,
                "Haemoptysis" = haemoptysis,
                "Night sweats" = nightsweats,
                "Enlarged lymph nodes" = lymphnodes,
                "Tachycardia" = tachycardia,
                "Tachypnoea" = tachypnoea,
                "Miliary pattern" = Miliary,
                "Pleural effusion" = Effusion) %>%
  Gmisc::getDescriptionStatsBy("Age (categories)",
                               "HIV status",
                               "Severe acute malnutrition",
                               "Study",
                               "Treated for TB",
                               "TB contact",
                               by = "Case definition", add_total_col = TRUE, hrzl_prop = FALSE, total_col_show_perc = TRUE, 
                               show_all_values = TRUE,
                               continuous_fn = describeMedian,
                               header_count = TRUE,
                               statistics = getPvalChiSq) %>%
  htmlTable::htmlTable(caption = "Sociodemographic characteristics by case definiion",
                       align = "center", width = "100%") %>%
  addHtmlTableStyle(css.cell = "padding-left: .9em; padding-right: .9em;",
                    css.header = "font-weight: normal")
```


### Figure 1: Flow of children through (A) TDA A (CRS) and (B) TDA B (CRS)

**A**

```{r}
# Prep data for flow chart 
library(dplyr)
library(tidyverse)

a <- subset(sub10, !is.na("PersID")) %>% summarise(a = n()) 
b <- subset(sub10, dangersigns == "Yes") %>% summarise(b = n())
c <- subset(sub10, dangersigns == "No") %>% summarise(c = n())
d <- subset(sub10, highrisk == "Yes" & dangersigns == "No") %>% summarise(d = n())
e <- subset(sub10, highrisk == "No" & dangersigns == "No") %>% summarise(e = n())
f <- subset(sub10, (sample == "Yes" | is.na(sample)) & dangersigns == "No") %>% summarise(f = n())
g <- subset(sub10, MTb_result == "MTB Positive" & dangersigns == "No") %>% summarise(g = n())
h <- subset(sub10, (MTb_result == "MTB Negative" | is.na(MTb_result)) & dangersigns == "No") %>% summarise(h = n())
i <- subset(sub10, TBContact == "Yes" & (MTb_result == "MTB Negative" | is.na(MTb_result)) & dangersigns == "No") %>% summarise(i = n())
j <- subset(sub10, TBContact == "No" & (MTb_result == "MTB Negative" | is.na(MTb_result)) & dangersigns == "No") %>% summarise(j = n())
k <- subset(sub10, Sum >= 10 & (MTb_result == "MTB Negative"| is.na(MTb_result)) & TBContact == "No" & dangersigns == "No") %>% summarise(k = n())
l <- subset(sub10, Sum < 10 & (MTb_result == "MTB Negative" | is.na(MTb_result)) & TBContact == "No" & dangersigns == "No") %>% summarise(l = n())
m <- subset(sub10, TxInitiation == "Yes" & dangersigns == "No") %>% summarise(m = n())

```

```{r}
library(consort)
library(labelled)
library(DiagrammeR)

# Define some sample data
data <- list(a=a$a, b=b$b, c=c$c, d=d$d, e=e$e, f=f$f, g=g$g, h=h$h, i=i$i, j=j$j, k=k$k, l=l$l, m=m$m)

DiagrammeR::grViz("
digraph graph_eos {

graph [layout = dot]

# node definitions with substituted label text
node [fontname = Helvetica, fontcolor = darkslategray,
        shape = rectangle, fixedsize = false, width = 2,
        style = filled, fillcolor = peachpuff1]
a [label = '@@1']
b [label = '@@2']
c [label = '@@3']
d [label = '@@4']
e [label = '@@5']
f [label = '@@6']
g [label = '@@7']
h [label = '@@8']
i [label = '@@9']
j [label = '@@10']
k [label = '@@11']
l [label = '@@12']
m [label = '@@13']

a -> b;
a -> c -> d -> f;
c -> e -> f -> g -> m;
f -> h -> i -> m;
h -> j -> k -> m;
j -> l;

}

[1]: paste0('Number children with symptoms suggestive of TB (n = ', data$a, ')')
[2]: paste0('Presence of danger signs requiring urgent medical care (n = ', data$b, ')')
[3]: paste0('No danger signs (n = ', data$c, ')')
[4]: paste0('High risk (n = ', data$d, ')')
[5]: paste0('Low risk (n = ', data$e, ')')
[6]: paste0('Respiratory/stool/urine sample collected for mWRD (n = ', data$f, ')')
[7]: paste0('mWRD detected Mycobacterium tuberculosis (n = ', data$g, ')')
[8]: paste0('mWRD did not detect Mycobacterium tuberculosis (or not done) (n = ', data$h, ')')
[9]: paste0('Close or household TB contact in previous 12 months (n = ', data$i, ')')
[10]: paste0('No TB contact in last 12 months (n = ', data$j, ')')
[11]: paste0('Sum A + Sum B > 10 (n = ', data$k, ')')
[12]: paste0('Sum A + Sum B ≤ 10 (n = ', data$l, ')')
[13]: paste0('Appropriate TB treatment initiated (n = ', data$m, ')')
")

```

```{r, include=FALSE}
rm(a,b,c,d,e,f,g,h,i,j,k,l,m)
```

```{r}
# Diagnostic classifications by stage
# 1. Microbiology
distribution_mtb_positive <- prop.table(table(sub10$DiagnClass_TDA[sub10$BinaryResult == "MTB Positive"]))
print("Distribution for Mtb positives")
print(distribution_mtb_positive)

# 2. TB contact
distribution_mtb_negative_contact_yes <- prop.table(table(sub10$DiagnClass_TDA[sub10$BinaryResult == "MTB Negative" & sub10$TBContact == "Yes"]))
print("Distribution for TB contacts:")
print(distribution_mtb_negative_contact_yes)

# 3. Score
distribution_mtb_negative_contact_no_sum_bin_yes <- prop.table(table(sub10$DiagnClass_TDA[sub10$BinaryResult == "MTB Negative" & sub10$TBContact == "No" & sub10$Sum_Bin == ">10"]))
print("Distribution for Sum > 10")
print(distribution_mtb_negative_contact_no_sum_bin_yes)

# 4. Treatment initiation
distribution_txinit <- prop.table(table(sub10$DiagnClass_TDA[sub10$TxInitiation == "Yes"]))
print("Distribution for treatment initiation")
print(distribution_txinit)
```

**B**

```{r}
# Prep data for flow chart 
library(dplyr)
library(tidyverse)

a <- subset(sub10, !is.na("PersID")) %>% summarise(a = n()) 
b <- subset(sub10, dangersigns == "Yes") %>% summarise(b = n())
c <- subset(sub10, dangersigns == "No") %>% summarise(c = n())
d <- subset(sub10, highrisk == "Yes" & dangersigns == "No") %>% summarise(d = n())
e <- subset(sub10, highrisk == "No" & dangersigns == "No") %>% summarise(e = n())
f <- subset(sub10, (sample == "Yes" | is.na(sample)) & dangersigns == "No") %>% summarise(f = n())
g <- subset(sub10, MTb_result == "MTB Positive" & dangersigns == "No") %>% summarise(g = n())
h <- subset(sub10, (MTb_result == "MTB Negative" | is.na(MTb_result)) & dangersigns == "No") %>% summarise(h = n())
i <- subset(sub10, TBContact == "Yes" & (MTb_result == "MTB Negative" | is.na(MTb_result)) & dangersigns == "No") %>% summarise(i = n())
j <- subset(sub10, TBContact == "No" & (MTb_result == "MTB Negative" | is.na(MTb_result)) & dangersigns == "No") %>% summarise(j = n())
k <- subset(sub10, Sum_B >= 10 & MTb_result != "MTB Positive" & TBContact == "No" & dangersigns == "No") %>% summarise(k = n())
l <- subset(sub10, Sum_B < 10 & MTb_result != "MTB Positive" & TBContact == "No" & dangersigns == "No") %>% summarise(l = n())
m <- subset(sub10, TxInitiation_B == "Yes" & dangersigns == "No") %>% summarise(m = n())

```

```{r}
library(consort)
library(labelled)
library(DiagrammeR)

# Define some sample data
data <- list(a=a$a, b=b$b, c=c$c, d=d$d, e=e$e, f=f$f, g=g$g, h=h$h, i=i$i, j=j$j, k=k$k, l=l$l, m=m$m)

DiagrammeR::grViz("
digraph graph_eos {

graph [layout = dot]

# node definitions with substituted label text
node [fontname = Helvetica, fontcolor = darkslategray,
        shape = rectangle, fixedsize = false, width = 2,
        style = filled, fillcolor = lightblue]
a [label = '@@1']
b [label = '@@2']
c [label = '@@3']
d [label = '@@4']
e [label = '@@5']
f [label = '@@6']
g [label = '@@7']
h [label = '@@8']
i [label = '@@9']
j [label = '@@10']
k [label = '@@11']
l [label = '@@12']
m [label = '@@13']

a -> b;
a -> c -> d -> f;
c -> e -> f -> g -> m;
f -> h -> i -> m;
h -> j -> k -> m;
j -> l;

}

[1]: paste0('Number children with symptoms suggestive of TB (n = ', data$a, ')')
[2]: paste0('Presence of danger signs requiring urgent medical care (n = ', data$b, ')')
[3]: paste0('No danger signs (n = ', data$c, ')')
[4]: paste0('High risk (n = ', data$d, ')')
[5]: paste0('Low risk (n = ', data$e, ')')
[6]: paste0('Respiratory/stool/urine sample collected for mWRD (n = ', data$f, ')')
[7]: paste0('mWRD detected Mycobacterium tuberculosis (n = ', data$g, ')')
[8]: paste0('mWRD did not detect Mycobacterium tuberculosis (or not done) (n = ', data$h, ')')
[9]: paste0('Close or household TB contact in previous 12 months (n = ', data$i, ')')
[10]: paste0('No TB contact in last 12 months (n = ', data$j, ')')
[11]: paste0('Sum > 10 (n = ', data$k, ')')
[12]: paste0('Sum ≤ 10 (n = ', data$l, ')')
[13]: paste0('Appropriate TB treatment initiated (n = ', data$m, ')')
")

```

```{r, include=FALSE}
rm(a,b,c,d,e,f,g,h,i,j,k,l,m)
```


### Figure 2: Score distribution of children eligible for scoring stratified by diagnostic classification, age, HIV status, and severe acute malnutrition

``` {r, include=FALSE}
# function for the raincloud plots later. this function if you look at it calculates the median
add_sample <- function(x){
   return(c(y = max(x) + .025, 
            label = length(x)))
}
```

```{r}
sub10 <- sub10 %>% mutate(sam = if_else(sam=="Yes", "SAM", "No SAM"))
```

TDA A 

```{r}
library(forcats)
library(hrbrthemes)
library(colorspace)

sub10 %>%
  ggplot(aes(fill = Outcome, y = Sum, x = Outcome)) + 
  geom_violin(alpha = 0.5, outlier.colour = "transparent") +
  geom_boxplot(position = position_dodge(width = 0.9), width = 0.2) + 
  scale_fill_manual(name = "Outcome", values = pal_union) +
  scale_color_manual(name = "Outcome", values = pal_union) +
  theme_minimal() +
  theme(axis.title.x = element_text(size = 14),
        axis.text.x = element_text(size = 13),  
        axis.text.y = element_text(size = 13),         
        legend.text = element_text(size = 14),          
        legend.title = element_text(size = 14)) +
  xlab("") +
  ylab("TDA score") +
  coord_flip() + 
  stat_summary(
    geom = "text",    
    fun.data = add_sample,
    aes(label = paste("n =", ..label..),
        color = Outcome,
        color = after_scale(darken(color, .1, space = "HLS"))),
    family = "Helvetica",
    size = 6,
    hjust = 0.75,
    vjust = 2.5,
    position = position_dodge(width = 0.9)
  ) + 
  stat_summary(
    geom = "text",
    fun = "median",
    aes(label = round(..y.., 2),
        color = Outcome,
        color = after_scale(darken(color, .1, space = "HLS"))),
    family = "Helvetica",
    fontface = "bold",
    size = 6,
    hjust = 1.05,
    vjust = -0.75,
    position = position_dodge(width = 0.9)
  )

# 1. TDA A: Age
pdf("/Users/lshlf15/Desktop/Decide-TB_Raincloud_Age_TDA-A.pdf", width = 12)
sub10 %>%
  mutate(age_cat_ext2 = fct_reorder(age_cat_ext2, Sum)) %>%
  mutate(age_cat_ext2 = factor(age_cat_ext2, levels=c("< 2 years", "2 - < 5 years", "5 - 10 years", "> 10 years"))) %>%
  ggplot(aes(fill=Outcome, y=Sum, x=age_cat_ext2)) + 
  geom_violin(alpha=0.5, outlier.colour="transparent") +
  geom_boxplot(position=position_dodge(width=0.9), width=0.2) + 
  scale_fill_manual(name = "Outcome", values = pal_union) +
  scale_color_manual(name = "Outcome", values = pal_union) +
  theme_minimal() +
  theme(axis.title.x = element_text(size = 14),
        axis.text.x = element_text(size = 13),  
        axis.text.y = element_text(size = 13),         
        legend.text = element_text(size = 14),          
        legend.title = element_text(size = 14)) +
  xlab("") +
  ylab("TDA score") +
  coord_flip() + 
  stat_summary(
    geom = "text",    
    fun.data = add_sample,
    aes(label = paste("n =", ..label..),
        color = Outcome,
        color = after_scale(darken(color, .1, space = "HLS"))),
    family = "Helvetica",
    size = 6,
    hjust = 0.75,
    vjust = 2.5,
    position = position_dodge(width = 0.9)
  ) + 
  stat_summary(
    geom = "text",
    fun = "median",
    aes(label = round(..y.., 2),
        color = Outcome,
        color = after_scale(darken(color, .1, space = "HLS"))),
    family = "Helvetica",
    fontface = "bold",
    size = 6,
    hjust = 1.05,
    vjust = -0.75,
    position = position_dodge(width = 0.9)
  )
dev.off()

# 2. TDA A: HIV
pdf("/Users/lshlf15/Desktop/Decide-TB_Raincloud_HIV_TDA-A.pdf", width = 12)
sub10 %>%
  mutate(hivstatus = fct_reorder(hivstatus, Sum)) %>%
  mutate(hivstatus = factor(hivstatus, levels=c("HIV positive", "HIV negative", "Unknown"))) %>%
  ggplot(aes(fill=Outcome, y=Sum, x=hivstatus)) + 
  geom_violin(alpha=0.5, outlier.colour="transparent") +
  geom_boxplot(position=position_dodge(width=0.9), width=0.2) + 
  scale_fill_manual(name = "Outcome", values = pal_union) +
  scale_color_manual(name = "Outcome", values = pal_union) +
  theme_minimal() +
  theme(axis.title.x = element_text(size = 14),
        axis.text.x = element_text(size = 13),  
        axis.text.y = element_text(size = 13),         
        legend.text = element_text(size = 14),          
        legend.title = element_text(size = 14)) +
  xlab("") +
  ylab("TDA score") +
  coord_flip() + 
  stat_summary(
    geom = "text",    
    fun.data = add_sample,
    aes(label = paste("n =", ..label..),
        color = Outcome,
        color = after_scale(darken(color, .1, space = "HLS"))),
    family = "Helvetica",
    size = 6,
    hjust = 0.75,
    vjust = 2.5,
    position = position_dodge(width = 0.9)
  ) + 
  stat_summary(
    geom = "text",
    fun = "median",
    aes(label = round(..y.., 2),
        color = Outcome,
        color = after_scale(darken(color, .1, space = "HLS"))),
    family = "Helvetica",
    fontface = "bold",
    size = 6,
    hjust = 1.05,
    vjust = -0.75,
    position = position_dodge(width = 0.9)
  )
dev.off()

# 3. TDA A: SAM
pdf("/Users/lshlf15/Desktop/Decide-TB_Raincloud_SAM_TDA-A.pdf", width = 12)
sub10 %>%
  mutate(sam = fct_reorder(sam, Sum)) %>%
  mutate(sam = factor(sam, levels=c("SAM", "No SAM"))) %>%
  ggplot(aes(fill=Outcome, y=Sum, x=sam)) + 
  geom_violin(alpha=0.5, outlier.colour="transparent") +
  geom_boxplot(position=position_dodge(width=0.9), width=0.2) + 
  scale_fill_manual(name = "Outcome", values = pal_union) +
  scale_color_manual(name = "Outcome", values = pal_union) +
  theme_minimal() +
  theme(axis.title.x = element_text(size = 14),
        axis.text.x = element_text(size = 13),  
        axis.text.y = element_text(size = 13),         
        legend.text = element_text(size = 14),          
        legend.title = element_text(size = 14)) +
  xlab("") +
  ylab("TDA score") +
  coord_flip() + 
  stat_summary(
    geom = "text",    
    fun.data = add_sample,
    aes(label = paste("n =", ..label..),
        color = Outcome,
        color = after_scale(darken(color, .1, space = "HLS"))),
    family = "Helvetica",
    size = 6,
    hjust = 0.75,
    vjust = 2.5,
    position = position_dodge(width = 0.9)
  ) + 
  stat_summary(
    geom = "text",
    fun = "median",
    aes(label = round(..y.., 2),
        color = Outcome,
        color = after_scale(darken(color, .1, space = "HLS"))),
    family = "Helvetica",
    fontface = "bold",
    size = 6,
    hjust = 1.05,
    vjust = -0.75,
    position = position_dodge(width = 0.9)
  )
dev.off()

# 4. TDA A: High risk
pdf("/Users/lshlf15/Desktop/Decide-TB_Raincloud_HighRisk_TDA-A.pdf", width = 12)
sub10 %>%
  mutate(high.risk = if_else(highrisk=="No", "Low risk", "High risk")) %>%
  mutate(high.risk = fct_reorder(high.risk, Sum)) %>%
  mutate(high.risk = factor(high.risk, levels=c("High risk", "Low risk"))) %>%
  ggplot(aes(fill=Outcome, y=Sum, x=high.risk)) + 
  geom_violin(alpha=0.5, outlier.colour="transparent") +
  geom_boxplot(position=position_dodge(width=0.9), width=0.2) + 
  scale_fill_manual(name = "Outcome", values = pal_union) +
  scale_color_manual(name = "Outcome", values = pal_union) +
  theme_minimal() +
  theme(axis.title.x = element_text(size = 14),
        axis.text.x = element_text(size = 13),  
        axis.text.y = element_text(size = 13),         
        legend.text = element_text(size = 14),          
        legend.title = element_text(size = 14)) +
  xlab("") +
  ylab("TDA score") +
  coord_flip() + 
  stat_summary(
    geom = "text",    
    fun.data = add_sample,
    aes(label = paste("n =", ..label..),
        color = Outcome,
        color = after_scale(darken(color, .1, space = "HLS"))),
    family = "Helvetica",
    size = 6,
    hjust = 0.75,
    vjust = 2.5,
    position = position_dodge(width = 0.9)
  ) + 
  stat_summary(
    geom = "text",
    fun = "median",
    aes(label = round(..y.., 2),
        color = Outcome,
        color = after_scale(darken(color, .1, space = "HLS"))),
    family = "Helvetica",
    fontface = "bold",
    size = 6,
    hjust = 1.05,
    vjust = -0.75,
    position = position_dodge(width = 0.9)
  )
dev.off()

# 5. TDA A: Site
pdf("/Users/lshlf15/Desktop/Decide-TB_Raincloud_Site_TDA-A.pdf", width = 12)
sub10 %>%
  mutate(study = fct_reorder(study, Sum)) %>%
  mutate(study = factor(study, levels=c("Cohort", "HIV", "RaPaed", "UMOYA"))) %>%
  ggplot(aes(fill=Outcome, y=Sum, x=study)) + 
  geom_violin(alpha=0.5, outlier.colour="transparent") +
  geom_boxplot(position=position_dodge(width=0.9), width=0.2) + 
  scale_fill_manual(name = "Outcome", values = pal_union) +
  scale_color_manual(name = "Outcome", values = pal_union) +
  theme_minimal() +
  theme(axis.title.x = element_text(size = 14),
        axis.text.x = element_text(size = 13),  
        axis.text.y = element_text(size = 13),         
        legend.text = element_text(size = 14),          
        legend.title = element_text(size = 14)) +
  xlab("") +
  ylab("TDA score") +
  coord_flip() + 
  stat_summary(
    geom = "text",    
    fun.data = add_sample,
    aes(label = paste("n =", ..label..),
        color = Outcome,
        color = after_scale(darken(color, .1, space = "HLS"))),
    family = "Helvetica",
    size = 6,
    hjust = 0.75,
    vjust = 2.5,
    position = position_dodge(width = 0.9)
  ) + 
  stat_summary(
    geom = "text",
    fun = "median",
    aes(label = round(..y.., 2),
        color = Outcome,
        color = after_scale(darken(color, .1, space = "HLS"))),
    family = "Helvetica",
    fontface = "bold",
    size = 6,
    hjust = 1.05,
    vjust = -0.75,
    position = position_dodge(width = 0.9)
  )
dev.off()
```

TDA B

```{r}
library(forcats)
library(hrbrthemes)

sub10 %>%
  ggplot(aes(fill = Outcome, y = Sum_B, x = Outcome)) + 
  geom_violin(alpha = 0.5, outlier.colour = "transparent") +
  geom_boxplot(position = position_dodge(width = 0.9), width = 0.2) + 
  scale_fill_manual(name = "Outcome", values = pal_union) +
  scale_color_manual(name = "Outcome", values = pal_union) +
  theme_minimal() +
  theme(axis.title.x = element_text(size = 14),
        axis.text.x = element_text(size = 13),  
        axis.text.y = element_text(size = 13),         
        legend.text = element_text(size = 14),          
        legend.title = element_text(size = 14)) +
  xlab("") +
  ylab("TDA score") +
  coord_flip() + 
  stat_summary(
    geom = "text",    
    fun.data = add_sample,
    aes(label = paste("n =", ..label..),
        color = Outcome,
        color = after_scale(darken(color, .1, space = "HLS"))),
    family = "Helvetica",
    size = 6,
    hjust = 0.75,
    vjust = 2.5,
    position = position_dodge(width = 0.9)
  ) + 
  stat_summary(
    geom = "text",
    fun = "median",
    aes(label = round(..y.., 2),
        color = Outcome,
        color = after_scale(darken(color, .1, space = "HLS"))),
    family = "Helvetica",
    fontface = "bold",
    size = 6,
    hjust = 1.05,
    vjust = -0.75,
    position = position_dodge(width = 0.9)
  )

# 1. TDA A: Age
pdf("/Users/lshlf15/Desktop/Decide-TB_Raincloud_Age_TDA-B.pdf", width = 12)
sub10 %>%
  mutate(age_cat_ext2 = fct_reorder(age_cat_ext2, Sum_B)) %>%
  mutate(age_cat_ext2 = factor(age_cat_ext2, levels=c("< 2 years", "2 - < 5 years", "5 - 10 years", "> 10 years"))) %>%
  ggplot(aes(fill=Outcome, y=Sum_B, x=age_cat_ext2)) + 
  geom_violin(alpha=0.5, outlier.colour="transparent") +
  geom_boxplot(position=position_dodge(width=0.9), width=0.2) + 
  scale_fill_manual(name = "Outcome", values = pal_union_b) +
  scale_color_manual(name = "Outcome", values = pal_union_b) +
  theme_minimal() +
  theme(axis.title.x = element_text(size = 14),
        axis.text.x = element_text(size = 13),  
        axis.text.y = element_text(size = 13),         
        legend.text = element_text(size = 14),          
        legend.title = element_text(size = 14)) +
  xlab("") +
  ylab("TDA score") +
  coord_flip() + 
  stat_summary(
    geom = "text",    
    fun.data = add_sample,
    aes(label = paste("n =", ..label..),
        color = Outcome,
        color = after_scale(darken(color, .1, space = "HLS"))),
    family = "Helvetica",
    size = 6,
    hjust = 0.75,
    vjust = 2.5,
    position = position_dodge(width = 0.9)
  ) + 
  stat_summary(
    geom = "text",
    fun = "median",
    aes(label = round(..y.., 2),
        color = Outcome,
        color = after_scale(darken(color, .1, space = "HLS"))),
    family = "Helvetica",
    fontface = "bold",
    size = 6,
    hjust = 1.05,
    vjust = -0.75,
    position = position_dodge(width = 0.9)
  )
dev.off()

# 2. TDA A: HIV
pdf("/Users/lshlf15/Desktop/Decide-TB_Raincloud_HIV_TDA-B.pdf", width = 12)
sub10 %>%
  mutate(hivstatus = fct_reorder(hivstatus, Sum_B)) %>%
  mutate(hivstatus = factor(hivstatus, levels=c("HIV positive", "HIV negative", "Unknown"))) %>%
  ggplot(aes(fill=Outcome, y=Sum_B, x=hivstatus)) + 
  geom_violin(alpha=0.5, outlier.colour="transparent") +
  geom_boxplot(position=position_dodge(width=0.9), width=0.2) + 
  scale_fill_manual(name = "Outcome", values = pal_union_b) +
  scale_color_manual(name = "Outcome", values = pal_union_b) +
  theme_minimal() +
  theme(axis.title.x = element_text(size = 14),
        axis.text.x = element_text(size = 13),  
        axis.text.y = element_text(size = 13),         
        legend.text = element_text(size = 14),          
        legend.title = element_text(size = 14)) +
  xlab("") +
  ylab("TDA score") +
  coord_flip() + 
  stat_summary(
    geom = "text",    
    fun.data = add_sample,
    aes(label = paste("n =", ..label..),
        color = Outcome,
        color = after_scale(darken(color, .1, space = "HLS"))),
    family = "Helvetica",
    size = 6,
    hjust = 0.75,
    vjust = 2.5,
    position = position_dodge(width = 0.9)
  ) + 
  stat_summary(
    geom = "text",
    fun = "median",
    aes(label = round(..y.., 2),
        color = Outcome,
        color = after_scale(darken(color, .1, space = "HLS"))),
    family = "Helvetica",
    fontface = "bold",
    size = 6,
    hjust = 1.05,
    vjust = -0.75,
    position = position_dodge(width = 0.9)
  )
dev.off()

# 3. TDA A: SAM
pdf("/Users/lshlf15/Desktop/Decide-TB_Raincloud_SAM_TDA-B.pdf", width = 12)
sub10 %>%
  mutate(sam = fct_reorder(sam, Sum_B)) %>%
  mutate(sam = factor(sam, levels=c("SAM", "No SAM"))) %>%
  ggplot(aes(fill=Outcome, y=Sum_B, x=sam)) + 
  geom_violin(alpha=0.5, outlier.colour="transparent") +
  geom_boxplot(position=position_dodge(width=0.9), width=0.2) + 
  scale_fill_manual(name = "Outcome", values = pal_union_b) +
  scale_color_manual(name = "Outcome", values = pal_union_b) +
  theme_minimal() +
  theme(axis.title.x = element_text(size = 14),
        axis.text.x = element_text(size = 13),  
        axis.text.y = element_text(size = 13),         
        legend.text = element_text(size = 14),          
        legend.title = element_text(size = 14)) +
  xlab("") +
  ylab("TDA score") +
  coord_flip() + 
  stat_summary(
    geom = "text",    
    fun.data = add_sample,
    aes(label = paste("n =", ..label..),
        color = Outcome,
        color = after_scale(darken(color, .1, space = "HLS"))),
    family = "Helvetica",
    size = 6,
    hjust = 0.75,
    vjust = 2.5,
    position = position_dodge(width = 0.9)
  ) + 
  stat_summary(
    geom = "text",
    fun = "median",
    aes(label = round(..y.., 2),
        color = Outcome,
        color = after_scale(darken(color, .1, space = "HLS"))),
    family = "Helvetica",
    fontface = "bold",
    size = 6,
    hjust = 1.05,
    vjust = -0.75,
    position = position_dodge(width = 0.9)
  )
dev.off()

# 4. TDA A: High risk
pdf("/Users/lshlf15/Desktop/Decide-TB_Raincloud_HighRisk_TDA-B.pdf", width = 12)
sub10 %>%
  mutate(high.risk = if_else(highrisk=="No", "Low risk", "High risk")) %>%
  mutate(high.risk = fct_reorder(high.risk, Sum_B)) %>%
  mutate(high.risk = factor(high.risk, levels=c("High risk", "Low risk"))) %>%
  ggplot(aes(fill=Outcome, y=Sum_B, x=high.risk)) + 
  geom_violin(alpha=0.5, outlier.colour="transparent") +
  geom_boxplot(position=position_dodge(width=0.9), width=0.2) + 
  scale_fill_manual(name = "Outcome", values = pal_union_b) +
  scale_color_manual(name = "Outcome", values = pal_union_b) +
  theme_minimal() +
  theme(axis.title.x = element_text(size = 14),
        axis.text.x = element_text(size = 13),  
        axis.text.y = element_text(size = 13),         
        legend.text = element_text(size = 14),          
        legend.title = element_text(size = 14)) +
  xlab("") +
  ylab("TDA score") +
  coord_flip() + 
  stat_summary(
    geom = "text",    
    fun.data = add_sample,
    aes(label = paste("n =", ..label..),
        color = Outcome,
        color = after_scale(darken(color, .1, space = "HLS"))),
    family = "Helvetica",
    size = 6,
    hjust = 0.75,
    vjust = 2.5,
    position = position_dodge(width = 0.9)
  ) + 
  stat_summary(
    geom = "text",
    fun = "median",
    aes(label = round(..y.., 2),
        color = Outcome,
        color = after_scale(darken(color, .1, space = "HLS"))),
    family = "Helvetica",
    fontface = "bold",
    size = 6,
    hjust = 1.05,
    vjust = -0.75,
    position = position_dodge(width = 0.9)
  )
dev.off()

# 5. TDA B: High risk
pdf("/Users/lshlf15/Desktop/Decide-TB_Raincloud_Site_TDA-B.pdf", width = 12)
sub10 %>%
  mutate(study = fct_reorder(study, Sum_B)) %>%
  mutate(study = factor(study, levels=c("Cohort", "HIV", "RaPaed", "UMOYA"))) %>%
  ggplot(aes(fill=Outcome, y=Sum_B, x=study)) + 
  geom_violin(alpha=0.5, outlier.colour="transparent") +
  geom_boxplot(position=position_dodge(width=0.9), width=0.2) + 
  scale_fill_manual(name = "Outcome", values = pal_union_b) +
  scale_color_manual(name = "Outcome", values = pal_union_b) +
  theme_minimal() +
  theme(axis.title.x = element_text(size = 14),
        axis.text.x = element_text(size = 13),  
        axis.text.y = element_text(size = 13),         
        legend.text = element_text(size = 14),          
        legend.title = element_text(size = 14)) +
  xlab("") +
  ylab("TDA score") +
  coord_flip() + 
  stat_summary(
    geom = "text",    
    fun.data = add_sample,
    aes(label = paste("n =", ..label..),
        color = Outcome,
        color = after_scale(darken(color, .1, space = "HLS"))),
    family = "Helvetica",
    size = 6,
    hjust = 0.75,
    vjust = 2.5,
    position = position_dodge(width = 0.9)
  ) + 
  stat_summary(
    geom = "text",
    fun = "median",
    aes(label = round(..y.., 2),
        color = Outcome,
        color = after_scale(darken(color, .1, space = "HLS"))),
    family = "Helvetica",
    fontface = "bold",
    size = 6,
    hjust = 1.05,
    vjust = -0.75,
    position = position_dodge(width = 0.9)
  )
dev.off()
```

### Table 2: Diagnostic accuracy of both treatment decision algorithms against a composite reference standard and clinician decision to treat

```{r}
sub10 <- sub10 %>% mutate(OutcomeTDA = if_else(TxInitiation == "Yes", 1, 0),
                          OutcomeTDA_B = if_else(TxInitiation_B == "Yes", 1, 0))
```

Table for diagnostic accuracy overall and by subgroup

```{r}
sub10 <- sub10 %>% mutate(Overall = "Overall")
```

```{r}
# Generate a dataframe just for those who make it to the score section
sub10_sumreq <- subset(sub10, Sum_required=="Yes")
```

```{r}
# Function to calculate Wilson score interval for binomial proportions
wilson_ci <- function(x, n, conf.level = 0.95) {
  p_hat <- x / n
  z <- qnorm(1 - (1 - conf.level) / 2)
  lower <- (2 * n * p_hat + z^2 - z * sqrt(z^2 - 1 / n + 4 * n * p_hat * (1 - p_hat) + (4 * p_hat - 2)))/(2 * (n + z^2))
  upper <- (2 * n * p_hat + z^2 + z * sqrt(z^2 - 1 / n + 4 * n * p_hat * (1 - p_hat) - (4 * p_hat - 2)))/(2 * (n + z^2))
  return(c(lower, upper))
}

# Define a function to compute sensitivity and specificity
compute_accuracy <- function(TP, FP, TN, FN) {
  sensitivity <- TP / (TP + FN) * 100
  specificity <- TN / (TN + FP) * 100
  return(c(TP = TP, FP = FP, TN = TN, FN = FN, Sensitivity = sensitivity, Specificity = specificity))
}
```

```{r}
# CRS
# TDA
# Define a function to compute accuracy for each subgroup
compute_TDA_accuracy_crs <- function(data, subgroup) {
  groups <- unique(data[[subgroup]])
  results <- list()
  for (group in groups) {
    sub_data <- data[data[[subgroup]] == group, ]
    TP <- sum(sub_data$OutcomeTDA == 1 & sub_data$CRS == 1)
    FP <- sum(sub_data$OutcomeTDA == 1 & sub_data$CRS == 0)
    TN <- sum(sub_data$OutcomeTDA == 0 & sub_data$CRS == 0)
    FN <- sum(sub_data$OutcomeTDA == 0 & sub_data$CRS == 1)
    results[[as.character(group)]] <- compute_accuracy(TP, FP, TN, FN)
  }
  return(results)
}

# CRS
# TDA
# Define a function to compute accuracy for each subgroup
compute_TDA_accuracy_crs_b <- function(data, subgroup) {
  groups <- unique(data[[subgroup]])
  results <- list()
  for (group in groups) {
    sub_data <- data[data[[subgroup]] == group, ]
    TP <- sum(sub_data$OutcomeTDA_B == 1 & sub_data$CRS == 1)
    FP <- sum(sub_data$OutcomeTDA_B == 1 & sub_data$CRS == 0)
    TN <- sum(sub_data$OutcomeTDA_B == 0 & sub_data$CRS == 0)
    FN <- sum(sub_data$OutcomeTDA_B == 0 & sub_data$CRS == 1)
    results[[as.character(group)]] <- compute_accuracy(TP, FP, TN, FN)
  }
  return(results)
}

```

**Diagnostic accuracy TDA A using CRS**

```{r}
# Compute accuracy for each subgroup
TDA_accuracy_overall <- compute_TDA_accuracy_crs(sub10, "Overall")
TDA_accuracy_study <- compute_TDA_accuracy_crs(sub10, "study")
TDA_accuracy_risk <- compute_TDA_accuracy_crs(sub10, "highrisk")
TDA_accuracy_hivstatus <- compute_TDA_accuracy_crs(sub10, "hivstatus")
TDA_accuracy_sam <- compute_TDA_accuracy_crs(sub10, "sam")
TDA_accuracy_age <- compute_TDA_accuracy_crs(sub10, "age_cat_ext2")

# Combine all results into a single dataframe
overall_results_TDA <- data.frame(Subgroup = names(TDA_accuracy_overall), do.call(rbind, TDA_accuracy_overall))
study_results_TDA <- data.frame(Subgroup = names(TDA_accuracy_study), do.call(rbind, TDA_accuracy_study))
risk_results_TDA <- data.frame(Subgroup = names(TDA_accuracy_risk), do.call(rbind, TDA_accuracy_risk))
hivstatus_results_TDA <- data.frame(Subgroup = names(TDA_accuracy_hivstatus), do.call(rbind, TDA_accuracy_hivstatus))
sam_results_TDA <- data.frame(Subgroup = names(TDA_accuracy_sam), do.call(rbind, TDA_accuracy_sam))
age_results_TDA <- data.frame(Subgroup = names(TDA_accuracy_age), do.call(rbind, TDA_accuracy_age))

# Add confidence intervals for sensitivity and specificity
ci_func <- function(x, n) wilson_ci(x, n)

# Apply confidence intervals for subgroup results
apply_ci <- function(result) {
  result$`Sensitivity 95% CI` <- apply(result[, c("TP", "FN")], 1, function(x) {
    ci_values <- ci_func(x[1], sum(x))
    paste0("(", round(ci_values[1] * 100, 2), "% - ", round(ci_values[2] * 100, 2), "%)")
  })
  result$`Specificity 95% CI` <- apply(result[, c("TN", "FP")], 1, function(x) {
    ci_values <- ci_func(x[1], sum(x))
    paste0("(", round(ci_values[1] * 100, 2), "% - ", round(ci_values[2] * 100, 2), "%)")
  })
  return(result)
}

overall_results_TDA <- apply_ci(overall_results_TDA)
study_results_TDA <- apply_ci(study_results_TDA)
risk_results_TDA <- apply_ci(risk_results_TDA)
hivstatus_results_TDA <- apply_ci(hivstatus_results_TDA)
sam_results_TDA <- apply_ci(sam_results_TDA)
age_results_TDA <- apply_ci(age_results_TDA)

# Combine all results into a single dataframe
all_results_TDA <- bind_rows(overall_results_TDA, study_results_TDA, risk_results_TDA, hivstatus_results_TDA, 
                         sam_results_TDA, age_results_TDA)
```

```{r}
# TDA
diagn_acc_TDA <- all_results_TDA[,c("Subgroup","TP","FP","FN","TN","Sensitivity","Sensitivity 95% CI","Specificity","Specificity 95% CI")]
row.names(diagn_acc_TDA) <- NULL

# Convert sensitivity and specificity to percentages with one decimal point
diagn_acc_TDA <- diagn_acc_TDA %>%
  mutate(Sensitivity = sprintf("%.1f%%", Sensitivity),
         Specificity = sprintf("%.1f%%", Specificity))
```

```{r}
library(kableExtra)
diagn_acc_TDA %>%
  kbl() %>%
  kable_paper("striped", full_width = F) %>%
  pack_rows("Study", 2, 5) %>%
  pack_rows("Risk group", 6, 7) %>%
  pack_rows("HIV status", 8, 10) %>%
  pack_rows("Malnutrition", 11, 12) %>%
  pack_rows("Age", 13, 15)

```

Pooled diagnostic accuracy based on random effects meta-analyses

```{r}
# Generate the dataframe needed
Studies <- data.frame(TP = c(323, 182, 225, 85),FN = c(41, 35, 25, 37),FP = c(280, 143, 97, 22),TN = c(96, 114, 121, 60),
  names = c("RaPaed", "UMOYA", "Cohort", "HIV")
)

library(mada)

# Fit the random effects model
fit.reitsma <- reitsma(Studies, method = "reml")
summary(fit.reitsma)

# Extract and back-transform sensitivity and specificity
logit_sens <- coef(fit.reitsma)[1, "tsens"]
logit_fpr  <- coef(fit.reitsma)[1, "tfpr"]

sens_pooled <- plogis(logit_sens)
spec_pooled <- 1 - plogis(logit_fpr)  # specificity = 1 - false positive rate

# Estimate overall prevalence from the data
total_TP_FN <- sum(Studies$TP + Studies$FN)
total_cases <- sum(Studies$TP + Studies$FN + Studies$FP + Studies$TN)
prevalence <- total_TP_FN / total_cases

# Compute pooled PPV and NPV
ppv_pooled <- (sens_pooled * prevalence) / 
              (sens_pooled * prevalence + (1 - spec_pooled) * (1 - prevalence))

npv_pooled <- (spec_pooled * (1 - prevalence)) /
              ((1 - sens_pooled) * prevalence + spec_pooled * (1 - prevalence))

# Print results
cat(sprintf("Pooled Sensitivity: %.3f\n", sens_pooled))
cat(sprintf("Pooled Specificity: %.3f\n", spec_pooled))
cat(sprintf("Estimated Prevalence: %.3f\n", prevalence))
cat(sprintf("Pooled PPV: %.3f\n", ppv_pooled))
cat(sprintf("Pooled NPV: %.3f\n", npv_pooled))
```

```{r}
plot(fit.reitsma,sroclwd=2, 
     main="SROC curve (bivariate model) for site-stratified accuracy estimates")
points(fpr(Studies),sens(Studies),pch=2) 
legend("bottomright",c("Data","Summary Estimate"),pch=c(2,1)) 
legend("topright",c("SROC","conf.region"),lwd=c(2,1))
```

```{r}
# Visualise forest plots
Studies.d <- madad(Studies)
plot1 <- forest(Studies.d, type = "sens", xlab = "Sensitivity",snames = Studies$names, cex=TRUE)
plot2 <- forest(Studies.d, type = "spec", xlab = "Specificity",snames = Studies$names, cex=TRUE)
```

**Diagnostic accuracy TDA B using CRS**

```{r}
# Compute accuracy for each subgroup
TDA_accuracy_overall <- compute_TDA_accuracy_crs_b(sub10, "Overall")
TDA_accuracy_study <- compute_TDA_accuracy_crs_b(sub10, "study")
TDA_accuracy_risk <- compute_TDA_accuracy_crs_b(sub10, "highrisk")
TDA_accuracy_hivstatus <- compute_TDA_accuracy_crs_b(sub10, "hivstatus")
TDA_accuracy_sam <- compute_TDA_accuracy_crs_b(sub10, "sam")
TDA_accuracy_age <- compute_TDA_accuracy_crs_b(sub10, "age_cat_ext2")

# Combine all results into a single dataframe
overall_results_TDA <- data.frame(Subgroup = names(TDA_accuracy_overall), do.call(rbind, TDA_accuracy_overall))
study_results_TDA <- data.frame(Subgroup = names(TDA_accuracy_study), do.call(rbind, TDA_accuracy_study))
risk_results_TDA <- data.frame(Subgroup = names(TDA_accuracy_risk), do.call(rbind, TDA_accuracy_risk))
hivstatus_results_TDA <- data.frame(Subgroup = names(TDA_accuracy_hivstatus), do.call(rbind, TDA_accuracy_hivstatus))
sam_results_TDA <- data.frame(Subgroup = names(TDA_accuracy_sam), do.call(rbind, TDA_accuracy_sam))
age_results_TDA <- data.frame(Subgroup = names(TDA_accuracy_age), do.call(rbind, TDA_accuracy_age))

# Add confidence intervals for sensitivity and specificity
ci_func <- function(x, n) wilson_ci(x, n)

# Apply confidence intervals for subgroup results
apply_ci <- function(result) {
  result$`Sensitivity 95% CI` <- apply(result[, c("TP", "FN")], 1, function(x) {
    ci_values <- ci_func(x[1], sum(x))
    paste0("(", round(ci_values[1] * 100, 2), "% - ", round(ci_values[2] * 100, 2), "%)")
  })
  result$`Specificity 95% CI` <- apply(result[, c("TN", "FP")], 1, function(x) {
    ci_values <- ci_func(x[1], sum(x))
    paste0("(", round(ci_values[1] * 100, 2), "% - ", round(ci_values[2] * 100, 2), "%)")
  })
  return(result)
}

overall_results_TDA <- apply_ci(overall_results_TDA)
study_results_TDA <- apply_ci(study_results_TDA)
risk_results_TDA <- apply_ci(risk_results_TDA)
hivstatus_results_TDA <- apply_ci(hivstatus_results_TDA)
sam_results_TDA <- apply_ci(sam_results_TDA)
age_results_TDA <- apply_ci(age_results_TDA)

# Combine all results into a single dataframe
all_results_TDA <- bind_rows(overall_results_TDA, study_results_TDA, risk_results_TDA, hivstatus_results_TDA, 
                         sam_results_TDA, age_results_TDA)
```

```{r}
# TDA
diagn_acc_TDA <- all_results_TDA[,c("Subgroup","TP","FP","FN","TN","Sensitivity","Sensitivity 95% CI","Specificity","Specificity 95% CI")]
row.names(diagn_acc_TDA) <- NULL

# Convert sensitivity and specificity to percentages with one decimal point
diagn_acc_TDA <- diagn_acc_TDA %>%
  mutate(Sensitivity = sprintf("%.1f%%", Sensitivity),
         Specificity = sprintf("%.1f%%", Specificity))
```

```{r}
library(kableExtra)
diagn_acc_TDA %>%
  kbl() %>%
  kable_paper("striped", full_width = F) %>%
  pack_rows("Study", 2, 5) %>%
  pack_rows("Risk group", 6, 7) %>%
  pack_rows("HIV status", 8, 10) %>%
  pack_rows("Malnutrition", 11, 12) %>%
  pack_rows("Age", 13, 15)

```

Pooled diagnostic accuracy based on random effects meta-analyses

```{r}
# Generate the dataframe needed
Studies <- data.frame(TP=c(343,184,237,104), FN=c(21,33,13,18), FP=c(307,162,149,49), TN=c(69,95,69,33))
Studies$names <- c("RaPaed","UMOYA","Cohort","HIV")

library(mada)
# Fit the random effects model
fit.reitsma <- reitsma(Studies, method = "reml")
summary(fit.reitsma)

library(mada)

# Fit the random effects model
fit.reitsma <- reitsma(Studies, method = "reml")
summary(fit.reitsma)

# Extract and back-transform sensitivity and specificity
logit_sens <- coef(fit.reitsma)[1, "tsens"]
logit_fpr  <- coef(fit.reitsma)[1, "tfpr"]

sens_pooled <- plogis(logit_sens)
spec_pooled <- 1 - plogis(logit_fpr)  # specificity = 1 - false positive rate

# Estimate overall prevalence from the data
total_TP_FN <- sum(Studies$TP + Studies$FN)
total_cases <- sum(Studies$TP + Studies$FN + Studies$FP + Studies$TN)
prevalence <- total_TP_FN / total_cases

# Compute pooled PPV and NPV
ppv_pooled <- (sens_pooled * prevalence) / 
              (sens_pooled * prevalence + (1 - spec_pooled) * (1 - prevalence))

npv_pooled <- (spec_pooled * (1 - prevalence)) /
              ((1 - sens_pooled) * prevalence + spec_pooled * (1 - prevalence))

# Print results
cat(sprintf("Pooled Sensitivity: %.3f\n", sens_pooled))
cat(sprintf("Pooled Specificity: %.3f\n", spec_pooled))
cat(sprintf("Estimated Prevalence: %.3f\n", prevalence))
cat(sprintf("Pooled PPV: %.3f\n", ppv_pooled))
cat(sprintf("Pooled NPV: %.3f\n", npv_pooled))
```

```{r}
plot(fit.reitsma,sroclwd=2, 
     main="SROC curve (bivariate model) for site-stratified accuracy estimates")
points(fpr(Studies),sens(Studies),pch=2) 
legend("bottomright",c("Data","Summary Estimate"),pch=c(2,1)) 
legend("topright",c("SROC","conf.region"),lwd=c(2,1))
```

```{r}
# Visualise forest plots
Studies.d <- madad(Studies)
plot1 <- forest(Studies.d, type = "sens", xlab = "Sensitivity",snames = Studies$names, cex=TRUE)
plot2 <- forest(Studies.d, type = "spec", xlab = "Specificity",snames = Studies$names, cex=TRUE)
```

McNemar test between diagnostic accuracy estimates for TDA A and TDA B

```{r}
disease <- subset(sub10, CRS==1)
nondisease <- subset(sub10, CRS==0)
```

```{r}
table(disease$TxInitiation, disease$TxInitiation_B)
table(nondisease$TxInitiation, nondisease$TxInitiation_B)
```


```{r}
# Sensitivity: Apply McNemar's test among the diseased group (True diseased subjects)
contingency_table_sens <- matrix(c(794,21,74,64), nrow = 2, byrow = TRUE)
mcnemar_test_sens <- mcnemar.test(contingency_table_sens)

cat("McNemar's test for Sensitivity:\n")
print(mcnemar_test_sens)


# Specificity: Apply McNemar's test among the non-diseased group (True non-diseased subjects)
contingency_table_spec <- matrix(c(511,31,156,235), nrow = 2, byrow = TRUE)
mcnemar_test_spec <- mcnemar.test(contingency_table_spec)

cat("McNemar's test for Specificity:\n")
print(mcnemar_test_spec)
```

### Figure 3: Agreement between recommendation to initiate treatment according to the TDA and actual clinician decision to treat and diagnostic case definition

```{r}
# Household level variables
sub10_TB <- subset(sub10, CRS==1)
sub10_noTB <- subset(sub10, CRS==0)

euler_TB <- sub10_TB %>%
  dplyr::mutate(
    Clinician = ifelse(Treatment == "Yes", 1, 0),
    TDA = ifelse(TxInitiation == "Yes", 1, 0),
    TDA_B = ifelse(TxInitiation_B == "Yes", 1, 0)) %>%
  ungroup()

euler_noTB <- sub10_noTB %>%
  dplyr::mutate(
    Clinician = ifelse(Treatment == "Yes", 1, 0),
    TDA = ifelse(TxInitiation == "Yes", 1, 0),
    TDA_B = ifelse(TxInitiation_B == "Yes", 1, 0)) %>%
  ungroup()
```

**TDA A**

```{r}
library(eulerr)
euler1 <- euler_TB %>%
    select(Clinician, TDA) %>%
    group_by(Clinician, TDA) %>%
    dplyr::summarise(N = n()) %>%
    mutate(percent = N/sum(N)) %>%
    mutate(
        Clinician = ifelse(Clinician == 1, "C", NA),
        TDA = ifelse(TDA == 1, "T", NA)) %>%
    unite("all", Clinician:TDA, na.rm = TRUE, sep = "&") %>%
    mutate(all = ifelse(all=='', "None", all)) %>%
    mutate(cat = ifelse(str_detect(all, "&"), "Multiple", all)) %>%
    ungroup()

euler1 <- euler1 %>% mutate(cat=if_else(cat=="None","N",cat),
                            all=if_else(all=="None","N",all))
 
euler_cd1 <- euler1 %>%
  select(all, N) %>%
  deframe()

euler2 <- euler_noTB %>%
    select(Clinician, TDA) %>%
    group_by(Clinician, TDA) %>%
    dplyr::summarise(N = n()) %>%
    mutate(percent = N/sum(N)) %>%
    mutate(
        Clinician = ifelse(Clinician == 1, "C", NA),
        TDA = ifelse(TDA == 1, "T", NA)) %>%
    unite("all", Clinician:TDA, na.rm = TRUE, sep = "&") %>%
    mutate(all = ifelse(all=='', "None", all)) %>%
    mutate(cat = ifelse(str_detect(all, "&"), "Multiple", all)) %>%
    ungroup()

euler2 <- euler2 %>% mutate(cat=if_else(cat=="None","N",cat),
                            all=if_else(all=="None","N",all))
 
euler_cd2 <- euler2 %>%
  select(all, N) %>%
  deframe()
```

```{r}
eulerr_options(fontsize = 18)

pdf("/Users/lshlf15/Desktop/Decide-TB_Euler_TDA-A_TB.pdf", width = 11)
plot(euler(euler_cd1,input = "disjoint"), quantities = list(type = "percent", cex = 2), labels = list(col = "black", fontsize = 18), fill = pal_union_alpha)
dev.off()

pdf("/Users/lshlf15/Desktop/Decide-TB_Euler_TDA-A_noTB.pdf", width = 11)
plot(euler(euler_cd2,input = "disjoint"), quantities = list(type = "percent", cex = 2), labels = list(col = "black", fontsize = 18), fill = pal_union_alpha)
dev.off()
```

**TDA B**

```{r}
library(eulerr)
euler3 <- euler_TB %>%
    select(Clinician, TDA_B) %>%
    group_by(Clinician, TDA_B) %>%
    dplyr::summarise(N = n()) %>%
    mutate(percent = N/sum(N)) %>%
    mutate(
        Clinician = ifelse(Clinician == 1, "C", NA),
        TDA_B = ifelse(TDA_B == 1, "T", NA)) %>%
    unite("all", Clinician:TDA_B, na.rm = TRUE, sep = "&") %>%
    mutate(all = ifelse(all=='', "None", all)) %>%
    mutate(cat = ifelse(str_detect(all, "&"), "Multiple", all)) %>%
    ungroup()

euler3 <- euler3 %>% mutate(cat=if_else(cat=="None","N",cat),
                            all=if_else(all=="None","N",all))
 
euler_cd3 <- euler3 %>%
  select(all, N) %>%
  deframe()

euler4 <- euler_noTB %>%
    select(Clinician, TDA_B) %>%
    group_by(Clinician, TDA_B) %>%
    dplyr::summarise(N = n()) %>%
    mutate(percent = N/sum(N)) %>%
    mutate(
        Clinician = ifelse(Clinician == 1, "C", NA),
        TDA_B = ifelse(TDA_B == 1, "T", NA)) %>%
    unite("all", Clinician:TDA_B, na.rm = TRUE, sep = "&") %>%
    mutate(all = ifelse(all=='', "None", all)) %>%
    mutate(cat = ifelse(str_detect(all, "&"), "Multiple", all)) %>%
    ungroup()

euler4 <- euler4 %>% mutate(cat=if_else(cat=="None","N",cat),
                            all=if_else(all=="None","N",all))
 
euler_cd4 <- euler4 %>%
  select(all, N) %>%
  deframe()
```

```{r}
pdf("/Users/lshlf15/Desktop/Decide-TB_Euler_TDA-B_TB.pdf", width = 11)
plot(euler(euler_cd3,input = "disjoint"), quantities = list(type = "percent", cex = 2), labels = list(col = "black", fontsize = 18), fill = pal_union_b_alpha)
dev.off()

pdf("/Users/lshlf15/Desktop/Decide-TB_Euler_TDA-B_noTB.pdf", width = 11)
plot(euler(euler_cd4,input = "disjoint"), quantities = list(type = "percent", cex = 2), labels = list(col = "black", fontsize = 18), fill = pal_union_b_alpha)
dev.off()
```

**Barplot**

```{r}
# Barplot
sub10 <- sub10 %>% mutate(
  Overlap_A = if_else(Treatment=="Yes" & TxInitiation=="Yes", "Both",
                      if_else(Treatment=="Yes" & TxInitiation=="No", "Clinician only",
                              if_else(Treatment=="No" & TxInitiation=="Yes","TDA only","Neither"))),
  Overlap_A = factor(Overlap_A, levels = c("Neither","TDA only","Clinician only","Both")),
  Overlap_B = if_else(Treatment=="Yes" & TxInitiation_B=="Yes", "Both",
                      if_else(Treatment=="Yes" & TxInitiation_B=="No", "Clinician only",
                              if_else(Treatment=="No" & TxInitiation_B=="Yes","TDA only","Neither"))),
  Overlap_B = factor(Overlap_B, levels = c("Neither","TDA only","Clinician only","Both"))
)
```

```{r}
library(tidyr)
pdf("/Users/lshlf15/Desktop/Decide-TB_Overlap.pdf", width = 11)

sub10_long <- sub10 %>%
  pivot_longer(cols = c(Overlap_A, Overlap_B),    
               names_to = "Overlap_Variable",     
               values_to = "Overlap_Category") %>%
  mutate(Overlap = if_else(Overlap_Variable=="Overlap_A", "TDA A", "TDA B")) %>%
  group_by(Outcome, Overlap, Overlap_Category) %>%
  summarise(Count = n(), .groups = "drop") %>% 
  group_by(Outcome, Overlap) %>%
  mutate(Percentage = Count / sum(Count) * 100) 

ggplot(sub10_long, aes(x = Overlap_Category, y = Percentage, fill = Overlap)) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.9)) +   
  geom_text(aes(label = sprintf("%.1f%%", Percentage)),  # Add percentage text
            position = position_dodge(width = 0.9), 
            vjust = -0.3, size = 3.5) +                 # Adjust position and size of text
  coord_flip() +                                       
  facet_wrap(~Outcome) +                               
  scale_fill_manual(values = c("#EF6C0080", "#1565C080")) +              
  theme_minimal() +
  theme(
    axis.title.y = element_blank(), 
    axis.title.x = element_text(size = 14), 
    axis.text.x = element_text(size = 12),
    axis.text.y = element_text(size = 12), 
    strip.text = element_text(size = 14),  
    legend.title = element_blank(),       
    legend.text = element_text(size = 12)
  ) +
  ylab("Recommendation for anti-TB treatment (percentage [%]") +
  xlab("Percentage of children with, or without TB") +
  labs(fill = "Overlap Category")

dev.off()
```

## Supplement

### Supplementary Figure 1: Cascade through TDA A stratified by included study in the IPD

**RaPaed**

```{r}
# Prep data for flow chart 
library(dplyr)
library(tidyverse)

a <- subset(rapaed_sub10, !is.na("PersID")) %>% summarise(a = n()) 
b <- subset(rapaed_sub10, dangersigns == "Yes") %>% summarise(b = n())
c <- subset(rapaed_sub10, dangersigns == "No") %>% summarise(c = n())
d <- subset(rapaed_sub10, highrisk == "Yes" & dangersigns == "No") %>% summarise(d = n())
e <- subset(rapaed_sub10, highrisk == "No" & dangersigns == "No") %>% summarise(e = n())
f <- subset(rapaed_sub10, (sample == "Yes" | is.na(sample)) & dangersigns == "No") %>% summarise(f = n())
g <- subset(rapaed_sub10, MTb_result == "MTB Positive" & dangersigns == "No") %>% summarise(g = n())
h <- subset(rapaed_sub10, (MTb_result == "MTB Negative" | is.na(MTb_result)) & dangersigns == "No") %>% summarise(h = n())
i <- subset(rapaed_sub10, TBContact == "Yes" & (MTb_result == "MTB Negative" | is.na(MTb_result)) & dangersigns == "No") %>% summarise(i = n())
j <- subset(rapaed_sub10, TBContact == "No" & (MTb_result == "MTB Negative" | is.na(MTb_result)) & dangersigns == "No") %>% summarise(j = n())
k <- subset(rapaed_sub10, Sum >= 10 & (MTb_result == "MTB Negative" | is.na(MTb_result)) & TBContact == "No" & dangersigns == "No") %>% summarise(k = n())
l <- subset(rapaed_sub10, Sum < 10 & (MTb_result == "MTB Negative" | is.na(MTb_result)) & TBContact == "No" & dangersigns == "No") %>% summarise(l = n())
m <- subset(rapaed_sub10, TxInitiation == "Yes" & dangersigns == "No") %>% summarise(m = n())

```

```{r}
library(consort)
library(labelled)
library(DiagrammeR)

# Define some sample data
data <- list(a=a$a, b=b$b, c=c$c, d=d$d, e=e$e, f=f$f, g=g$g, h=h$h, i=i$i, j=j$j, k=k$k, l=l$l, m=m$m)

DiagrammeR::grViz("
digraph graph_eos {

graph [layout = dot]

# node definitions with substituted label text
node [fontname = Helvetica, fontcolor = darkslategray,
        shape = rectangle, fixedsize = false, width = 2,
        style = filled, fillcolor = peachpuff1]
a [label = '@@1']
b [label = '@@2']
c [label = '@@3']
d [label = '@@4']
e [label = '@@5']
f [label = '@@6']
g [label = '@@7']
h [label = '@@8']
i [label = '@@9']
j [label = '@@10']
k [label = '@@11']
l [label = '@@12']
m [label = '@@13']

a -> b;
a -> c -> d -> f;
c -> e -> f -> g -> m;
f -> h -> i -> m;
h -> j -> k -> m;
j -> l;

}

[1]: paste0('Number children with symptoms suggestive of TB (n = ', data$a, ')')
[2]: paste0('Presence of danger signs requiring urgent medical care (n = ', data$b, ')')
[3]: paste0('No danger signs (n = ', data$c, ')')
[4]: paste0('High risk (n = ', data$d, ')')
[5]: paste0('Low risk (n = ', data$e, ')')
[6]: paste0('Respiratory/stool/urine sample collected for mWRD (n = ', data$f, ')')
[7]: paste0('mWRD detected Mycobacterium tuberculosis (n = ', data$g, ')')
[8]: paste0('mWRD did not detect Mycobacterium tuberculosis (or not done) (n = ', data$h, ')')
[9]: paste0('Close or household TB contact in previous 12 months (n = ', data$i, ')')
[10]: paste0('No TB contact in last 12 months (n = ', data$j, ')')
[11]: paste0('Sum A + Sum B > 10 (n = ', data$k, ')')
[12]: paste0('Sum A + Sum B ≤ 10 (n = ', data$l, ')')
[13]: paste0('Appropriate TB treatment initiated (n = ', data$m, ')')
")

```

```{r, include=FALSE}
rm(a,b,c,d,e,f,g,h,i,j,k,l,m)
```

**UMOYA**

```{r}
# Prep data for flow chart 
library(dplyr)
library(tidyverse)

a <- subset(umoya_sub10, !is.na("PersID")) %>% summarise(a = n()) 
b <- subset(umoya_sub10, dangersigns == "Yes") %>% summarise(b = n())
c <- subset(umoya_sub10, dangersigns == "No") %>% summarise(c = n())
d <- subset(umoya_sub10, highrisk == "Yes" & dangersigns == "No") %>% summarise(d = n())
e <- subset(umoya_sub10, highrisk == "No" & dangersigns == "No") %>% summarise(e = n())
f <- subset(umoya_sub10, (sample == "Yes" | is.na(sample)) & dangersigns == "No") %>% summarise(f = n())
g <- subset(umoya_sub10, MTb_result == "MTB Positive" & dangersigns == "No") %>% summarise(g = n())
h <- subset(umoya_sub10, (MTb_result == "MTB Negative" | is.na(MTb_result)) & dangersigns == "No") %>% summarise(h = n())
i <- subset(umoya_sub10, TBContact == "Yes" & (MTb_result == "MTB Negative" | is.na(MTb_result)) & dangersigns == "No") %>% summarise(i = n())
j <- subset(umoya_sub10, TBContact == "No" & (MTb_result == "MTB Negative" | is.na(MTb_result)) & dangersigns == "No") %>% summarise(j = n())
k <- subset(umoya_sub10, Sum >= 10 & (MTb_result == "MTB Negative" | is.na(MTb_result)) & TBContact == "No" & dangersigns == "No") %>% summarise(k = n())
l <- subset(umoya_sub10, Sum < 10 & (MTb_result == "MTB Negative" | is.na(MTb_result)) & TBContact == "No" & dangersigns == "No") %>% summarise(l = n())
m <- subset(umoya_sub10, TxInitiation == "Yes" & dangersigns == "No") %>% summarise(m = n())

```

```{r}
library(consort)
library(labelled)
library(DiagrammeR)

# Define some sample data
data <- list(a=a$a, b=b$b, c=c$c, d=d$d, e=e$e, f=f$f, g=g$g, h=h$h, i=i$i, j=j$j, k=k$k, l=l$l, m=m$m)

DiagrammeR::grViz("
digraph graph_eos {

graph [layout = dot]

# node definitions with substituted label text
node [fontname = Helvetica, fontcolor = darkslategray,
        shape = rectangle, fixedsize = false, width = 2,
        style = filled, fillcolor = peachpuff1]
a [label = '@@1']
b [label = '@@2']
c [label = '@@3']
d [label = '@@4']
e [label = '@@5']
f [label = '@@6']
g [label = '@@7']
h [label = '@@8']
i [label = '@@9']
j [label = '@@10']
k [label = '@@11']
l [label = '@@12']
m [label = '@@13']

a -> b;
a -> c -> d -> f;
c -> e -> f -> g -> m;
f -> h -> i -> m;
h -> j -> k -> m;
j -> l;

}

[1]: paste0('Number children with symptoms suggestive of TB (n = ', data$a, ')')
[2]: paste0('Presence of danger signs requiring urgent medical care (n = ', data$b, ')')
[3]: paste0('No danger signs (n = ', data$c, ')')
[4]: paste0('High risk (n = ', data$d, ')')
[5]: paste0('Low risk (n = ', data$e, ')')
[6]: paste0('Respiratory/stool/urine sample collected for mWRD (n = ', data$f, ')')
[7]: paste0('mWRD detected Mycobacterium tuberculosis (n = ', data$g, ')')
[8]: paste0('mWRD did not detect Mycobacterium tuberculosis (or not done) (n = ', data$h, ')')
[9]: paste0('Close or household TB contact in previous 12 months (n = ', data$i, ')')
[10]: paste0('No TB contact in last 12 months (n = ', data$j, ')')
[11]: paste0('Sum A + Sum B > 10 (n = ', data$k, ')')
[12]: paste0('Sum A + Sum B ≤ 10 (n = ', data$l, ')')
[13]: paste0('Appropriate TB treatment initiated (n = ', data$m, ')')
")

```

```{r, include=FALSE}
rm(a,b,c,d,e,f,g,h,i,j,k,l,m)
```

**Cohort**

```{r}
# Prep data for flow chart 
library(dplyr)
library(tidyverse)

a <- subset(cohort_sub10, !is.na("PersID")) %>% summarise(a = n()) 
b <- subset(cohort_sub10, dangersigns == "Yes") %>% summarise(b = n())
c <- subset(cohort_sub10, dangersigns == "No") %>% summarise(c = n())
d <- subset(cohort_sub10, highrisk == "Yes" & dangersigns == "No") %>% summarise(d = n())
e <- subset(cohort_sub10, highrisk == "No" & dangersigns == "No") %>% summarise(e = n())
f <- subset(cohort_sub10, (sample == "Yes" | is.na(sample)) & dangersigns == "No") %>% summarise(f = n())
g <- subset(cohort_sub10, MTb_result == "MTB Positive" & dangersigns == "No") %>% summarise(g = n())
h <- subset(cohort_sub10, (MTb_result == "MTB Negative" | is.na(MTb_result)) & dangersigns == "No") %>% summarise(h = n())
i <- subset(cohort_sub10, TBContact == "Yes" & (MTb_result == "MTB Negative" | is.na(MTb_result)) & dangersigns == "No") %>% summarise(i = n())
j <- subset(cohort_sub10, TBContact == "No" & (MTb_result == "MTB Negative" | is.na(MTb_result)) & dangersigns == "No") %>% summarise(j = n())
k <- subset(cohort_sub10, Sum >= 10 & (MTb_result == "MTB Negative" | is.na(MTb_result)) & TBContact == "No" & dangersigns == "No") %>% summarise(k = n())
l <- subset(cohort_sub10, Sum < 10 & (MTb_result == "MTB Negative" | is.na(MTb_result)) & TBContact == "No" & dangersigns == "No") %>% summarise(l = n())
m <- subset(cohort_sub10, TxInitiation == "Yes" & dangersigns == "No") %>% summarise(m = n())

```

```{r}
library(consort)
library(labelled)
library(DiagrammeR)

# Define some sample data
data <- list(a=a$a, b=b$b, c=c$c, d=d$d, e=e$e, f=f$f, g=g$g, h=h$h, i=i$i, j=j$j, k=k$k, l=l$l, m=m$m)

DiagrammeR::grViz("
digraph graph_eos {

graph [layout = dot]

# node definitions with substituted label text
node [fontname = Helvetica, fontcolor = darkslategray,
        shape = rectangle, fixedsize = false, width = 2,
        style = filled, fillcolor = peachpuff1]
a [label = '@@1']
b [label = '@@2']
c [label = '@@3']
d [label = '@@4']
e [label = '@@5']
f [label = '@@6']
g [label = '@@7']
h [label = '@@8']
i [label = '@@9']
j [label = '@@10']
k [label = '@@11']
l [label = '@@12']
m [label = '@@13']

a -> b;
a -> c -> d -> f;
c -> e -> f -> g -> m;
f -> h -> i -> m;
h -> j -> k -> m;
j -> l;

}

[1]: paste0('Number children with symptoms suggestive of TB (n = ', data$a, ')')
[2]: paste0('Presence of danger signs requiring urgent medical care (n = ', data$b, ')')
[3]: paste0('No danger signs (n = ', data$c, ')')
[4]: paste0('High risk (n = ', data$d, ')')
[5]: paste0('Low risk (n = ', data$e, ')')
[6]: paste0('Respiratory/stool/urine sample collected for mWRD (n = ', data$f, ')')
[7]: paste0('mWRD detected Mycobacterium tuberculosis (n = ', data$g, ')')
[8]: paste0('mWRD did not detect Mycobacterium tuberculosis (or not done) (n = ', data$h, ')')
[9]: paste0('Close or household TB contact in previous 12 months (n = ', data$i, ')')
[10]: paste0('No TB contact in last 12 months (n = ', data$j, ')')
[11]: paste0('Sum A + Sum B > 10 (n = ', data$k, ')')
[12]: paste0('Sum A + Sum B ≤ 10 (n = ', data$l, ')')
[13]: paste0('Appropriate TB treatment initiated (n = ', data$m, ')')
")

```

```{r, include=FALSE}
rm(a,b,c,d,e,f,g,h,i,j,k,l,m)
```

**HIV**

```{r}
# Prep data for flow chart 
library(dplyr)
library(tidyverse)

a <- subset(hiv_sub10, !is.na("PersID")) %>% summarise(a = n()) 
b <- subset(hiv_sub10, dangersigns == "Yes") %>% summarise(b = n())
c <- subset(hiv_sub10, dangersigns == "No") %>% summarise(c = n())
d <- subset(hiv_sub10, highrisk == "Yes" & dangersigns == "No") %>% summarise(d = n())
e <- subset(hiv_sub10, highrisk == "No" & dangersigns == "No") %>% summarise(e = n())
f <- subset(hiv_sub10, (sample == "Yes" | is.na(sample)) & dangersigns == "No") %>% summarise(f = n())
g <- subset(hiv_sub10, MTb_result == "MTB Positive" & dangersigns == "No") %>% summarise(g = n())
h <- subset(hiv_sub10, (MTb_result == "MTB Negative" | is.na(MTb_result)) & dangersigns == "No") %>% summarise(h = n())
i <- subset(hiv_sub10, TBContact == "Yes" & (MTb_result == "MTB Negative" | is.na(MTb_result)) & dangersigns == "No") %>% summarise(i = n())
j <- subset(hiv_sub10, TBContact == "No" & (MTb_result == "MTB Negative" | is.na(MTb_result)) & dangersigns == "No") %>% summarise(j = n())
k <- subset(hiv_sub10, Sum >= 10 & (MTb_result == "MTB Negative" | is.na(MTb_result)) & TBContact == "No" & dangersigns == "No") %>% summarise(k = n())
l <- subset(hiv_sub10, Sum < 10 & (MTb_result == "MTB Negative" | is.na(MTb_result)) & TBContact == "No" & dangersigns == "No") %>% summarise(l = n())
m <- subset(hiv_sub10, TxInitiation == "Yes" & dangersigns == "No") %>% summarise(m = n())

```

```{r}
library(consort)
library(labelled)
library(DiagrammeR)

# Define some sample data
data <- list(a=a$a, b=b$b, c=c$c, d=d$d, e=e$e, f=f$f, g=g$g, h=h$h, i=i$i, j=j$j, k=k$k, l=l$l, m=m$m)

DiagrammeR::grViz("
digraph graph_eos {

graph [layout = dot]

# node definitions with substituted label text
node [fontname = Helvetica, fontcolor = darkslategray,
        shape = rectangle, fixedsize = false, width = 2,
        style = filled, fillcolor = peachpuff1]
a [label = '@@1']
b [label = '@@2']
c [label = '@@3']
d [label = '@@4']
e [label = '@@5']
f [label = '@@6']
g [label = '@@7']
h [label = '@@8']
i [label = '@@9']
j [label = '@@10']
k [label = '@@11']
l [label = '@@12']
m [label = '@@13']

a -> b;
a -> c -> d -> f;
c -> e -> f -> g -> m;
f -> h -> i -> m;
h -> j -> k -> m;
j -> l;

}

[1]: paste0('Number children with symptoms suggestive of TB (n = ', data$a, ')')
[2]: paste0('Presence of danger signs requiring urgent medical care (n = ', data$b, ')')
[3]: paste0('No danger signs (n = ', data$c, ')')
[4]: paste0('High risk (n = ', data$d, ')')
[5]: paste0('Low risk (n = ', data$e, ')')
[6]: paste0('Respiratory/stool/urine sample collected for mWRD (n = ', data$f, ')')
[7]: paste0('mWRD detected Mycobacterium tuberculosis (n = ', data$g, ')')
[8]: paste0('mWRD did not detect Mycobacterium tuberculosis (or not done) (n = ', data$h, ')')
[9]: paste0('Close or household TB contact in previous 12 months (n = ', data$i, ')')
[10]: paste0('No TB contact in last 12 months (n = ', data$j, ')')
[11]: paste0('Sum A + Sum B > 10 (n = ', data$k, ')')
[12]: paste0('Sum A + Sum B ≤ 10 (n = ', data$l, ')')
[13]: paste0('Appropriate TB treatment initiated (n = ', data$m, ')')
")

```

```{r, include=FALSE}
rm(a,b,c,d,e,f,g,h,i,j,k,l,m)
```

### Supplementary Figure 2: Cascade through TDA B stratified by included study in the IPD

**RaPaed**

```{r}
# Prep data for flow chart 
library(dplyr)
library(tidyverse)

a <- subset(rapaed_sub10, !is.na("PersID")) %>% summarise(a = n()) 
b <- subset(rapaed_sub10, dangersigns == "Yes") %>% summarise(b = n())
c <- subset(rapaed_sub10, dangersigns == "No") %>% summarise(c = n())
d <- subset(rapaed_sub10, highrisk == "Yes" & dangersigns == "No") %>% summarise(d = n())
e <- subset(rapaed_sub10, highrisk == "No" & dangersigns == "No") %>% summarise(e = n())
f <- subset(rapaed_sub10, (sample == "Yes" | is.na(sample)) & dangersigns == "No") %>% summarise(f = n())
g <- subset(rapaed_sub10, MTb_result == "MTB Positive" & dangersigns == "No") %>% summarise(g = n())
h <- subset(rapaed_sub10, (MTb_result == "MTB Negative" | is.na(MTb_result)) & dangersigns == "No") %>% summarise(h = n())
i <- subset(rapaed_sub10, TBContact == "Yes" & (MTb_result == "MTB Negative" | is.na(MTb_result)) & dangersigns == "No") %>% summarise(i = n())
j <- subset(rapaed_sub10, TBContact == "No" & (MTb_result == "MTB Negative" | is.na(MTb_result)) & dangersigns == "No") %>% summarise(j = n())
k <- subset(rapaed_sub10, Sum_B >= 10 & (MTb_result == "MTB Negative" | is.na(MTb_result)) & TBContact == "No" & dangersigns == "No") %>% summarise(k = n())
l <- subset(rapaed_sub10, Sum_B < 10 & (MTb_result == "MTB Negative" | is.na(MTb_result)) & TBContact == "No" & dangersigns == "No") %>% summarise(l = n())
m <- subset(rapaed_sub10, TxInitiation_B == "Yes" & dangersigns == "No") %>% summarise(m = n())

```

```{r}
library(consort)
library(labelled)
library(DiagrammeR)

# Define some sample data
data <- list(a=a$a, b=b$b, c=c$c, d=d$d, e=e$e, f=f$f, g=g$g, h=h$h, i=i$i, j=j$j, k=k$k, l=l$l, m=m$m)

DiagrammeR::grViz("
digraph graph_eos {

graph [layout = dot]

# node definitions with substituted label text
node [fontname = Helvetica, fontcolor = darkslategray,
        shape = rectangle, fixedsize = false, width = 2,
        style = filled, fillcolor = AliceBlue]
a [label = '@@1']
b [label = '@@2']
c [label = '@@3']
d [label = '@@4']
e [label = '@@5']
f [label = '@@6']
g [label = '@@7']
h [label = '@@8']
i [label = '@@9']
j [label = '@@10']
k [label = '@@11']
l [label = '@@12']
m [label = '@@13']

a -> b;
a -> c -> d -> f;
c -> e -> f -> g -> m;
f -> h -> i -> m;
h -> j -> k -> m;
j -> l;

}

[1]: paste0('Number children with symptoms suggestive of TB (n = ', data$a, ')')
[2]: paste0('Presence of danger signs requiring urgent medical care (n = ', data$b, ')')
[3]: paste0('No danger signs (n = ', data$c, ')')
[4]: paste0('High risk (n = ', data$d, ')')
[5]: paste0('Low risk (n = ', data$e, ')')
[6]: paste0('Respiratory/stool/urine sample collected for mWRD (n = ', data$f, ')')
[7]: paste0('mWRD detected Mycobacterium tuberculosis (n = ', data$g, ')')
[8]: paste0('mWRD did not detect Mycobacterium tuberculosis (or not done) (n = ', data$h, ')')
[9]: paste0('Close or household TB contact in previous 12 months (n = ', data$i, ')')
[10]: paste0('No TB contact in last 12 months (n = ', data$j, ')')
[11]: paste0('Sum A + Sum B > 10 (n = ', data$k, ')')
[12]: paste0('Sum A + Sum B ≤ 10 (n = ', data$l, ')')
[13]: paste0('Appropriate TB treatment initiated (n = ', data$m, ')')
")

```

```{r, include=FALSE}
rm(a,b,c,d,e,f,g,h,i,j,k,l,m)
```

**UMOYA**

```{r}
# Prep data for flow chart 
library(dplyr)
library(tidyverse)

a <- subset(umoya_sub10, !is.na("PersID")) %>% summarise(a = n()) 
b <- subset(umoya_sub10, dangersigns == "Yes") %>% summarise(b = n())
c <- subset(umoya_sub10, dangersigns == "No") %>% summarise(c = n())
d <- subset(umoya_sub10, highrisk == "Yes" & dangersigns == "No") %>% summarise(d = n())
e <- subset(umoya_sub10, highrisk == "No" & dangersigns == "No") %>% summarise(e = n())
f <- subset(umoya_sub10, (sample == "Yes" | is.na(sample)) & dangersigns == "No") %>% summarise(f = n())
g <- subset(umoya_sub10, MTb_result == "MTB Positive" & dangersigns == "No") %>% summarise(g = n())
h <- subset(umoya_sub10, (MTb_result == "MTB Negative" | is.na(MTb_result)) & dangersigns == "No") %>% summarise(h = n())
i <- subset(umoya_sub10, TBContact == "Yes" & (MTb_result == "MTB Negative" | is.na(MTb_result)) & dangersigns == "No") %>% summarise(i = n())
j <- subset(umoya_sub10, TBContact == "No" & (MTb_result == "MTB Negative" | is.na(MTb_result)) & dangersigns == "No") %>% summarise(j = n())
k <- subset(umoya_sub10, Sum_B >= 10 & (MTb_result == "MTB Negative" | is.na(MTb_result)) & TBContact == "No" & dangersigns == "No") %>% summarise(k = n())
l <- subset(umoya_sub10, Sum_B < 10 & (MTb_result == "MTB Negative" | is.na(MTb_result)) & TBContact == "No" & dangersigns == "No") %>% summarise(l = n())
m <- subset(umoya_sub10, TxInitiation_B == "Yes" & dangersigns == "No") %>% summarise(m = n())

```

```{r}
library(consort)
library(labelled)
library(DiagrammeR)

# Define some sample data
data <- list(a=a$a, b=b$b, c=c$c, d=d$d, e=e$e, f=f$f, g=g$g, h=h$h, i=i$i, j=j$j, k=k$k, l=l$l, m=m$m)

DiagrammeR::grViz("
digraph graph_eos {

graph [layout = dot]

# node definitions with substituted label text
node [fontname = Helvetica, fontcolor = darkslategray,
        shape = rectangle, fixedsize = false, width = 2,
        style = filled, fillcolor = AliceBlue]
a [label = '@@1']
b [label = '@@2']
c [label = '@@3']
d [label = '@@4']
e [label = '@@5']
f [label = '@@6']
g [label = '@@7']
h [label = '@@8']
i [label = '@@9']
j [label = '@@10']
k [label = '@@11']
l [label = '@@12']
m [label = '@@13']

a -> b;
a -> c -> d -> f;
c -> e -> f -> g -> m;
f -> h -> i -> m;
h -> j -> k -> m;
j -> l;

}

[1]: paste0('Number children with symptoms suggestive of TB (n = ', data$a, ')')
[2]: paste0('Presence of danger signs requiring urgent medical care (n = ', data$b, ')')
[3]: paste0('No danger signs (n = ', data$c, ')')
[4]: paste0('High risk (n = ', data$d, ')')
[5]: paste0('Low risk (n = ', data$e, ')')
[6]: paste0('Respiratory/stool/urine sample collected for mWRD (n = ', data$f, ')')
[7]: paste0('mWRD detected Mycobacterium tuberculosis (n = ', data$g, ')')
[8]: paste0('mWRD did not detect Mycobacterium tuberculosis (or not done) (n = ', data$h, ')')
[9]: paste0('Close or household TB contact in previous 12 months (n = ', data$i, ')')
[10]: paste0('No TB contact in last 12 months (n = ', data$j, ')')
[11]: paste0('Sum A + Sum B > 10 (n = ', data$k, ')')
[12]: paste0('Sum A + Sum B ≤ 10 (n = ', data$l, ')')
[13]: paste0('Appropriate TB treatment initiated (n = ', data$m, ')')
")

```

```{r, include=FALSE}
rm(a,b,c,d,e,f,g,h,i,j,k,l,m)
```

**Cohort**

```{r}
# Prep data for flow chart 
library(dplyr)
library(tidyverse)

a <- subset(cohort_sub10, !is.na("PersID")) %>% summarise(a = n()) 
b <- subset(cohort_sub10, dangersigns == "Yes") %>% summarise(b = n())
c <- subset(cohort_sub10, dangersigns == "No") %>% summarise(c = n())
d <- subset(cohort_sub10, highrisk == "Yes" & dangersigns == "No") %>% summarise(d = n())
e <- subset(cohort_sub10, highrisk == "No" & dangersigns == "No") %>% summarise(e = n())
f <- subset(cohort_sub10, (sample == "Yes" | is.na(sample)) & dangersigns == "No") %>% summarise(f = n())
g <- subset(cohort_sub10, MTb_result == "MTB Positive" & dangersigns == "No") %>% summarise(g = n())
h <- subset(cohort_sub10, (MTb_result == "MTB Negative" | is.na(MTb_result)) & dangersigns == "No") %>% summarise(h = n())
i <- subset(cohort_sub10, TBContact == "Yes" & (MTb_result == "MTB Negative" | is.na(MTb_result)) & dangersigns == "No") %>% summarise(i = n())
j <- subset(cohort_sub10, TBContact == "No" & (MTb_result == "MTB Negative" | is.na(MTb_result)) & dangersigns == "No") %>% summarise(j = n())
k <- subset(cohort_sub10, Sum_B >= 10 & (MTb_result == "MTB Negative" | is.na(MTb_result)) & TBContact == "No" & dangersigns == "No") %>% summarise(k = n())
l <- subset(cohort_sub10, Sum_B < 10 & (MTb_result == "MTB Negative" | is.na(MTb_result)) & TBContact == "No" & dangersigns == "No") %>% summarise(l = n())
m <- subset(cohort_sub10, TxInitiation_B == "Yes" & dangersigns == "No") %>% summarise(m = n())

```

```{r}
library(consort)
library(labelled)
library(DiagrammeR)

# Define some sample data
data <- list(a=a$a, b=b$b, c=c$c, d=d$d, e=e$e, f=f$f, g=g$g, h=h$h, i=i$i, j=j$j, k=k$k, l=l$l, m=m$m)

DiagrammeR::grViz("
digraph graph_eos {

graph [layout = dot]

# node definitions with substituted label text
node [fontname = Helvetica, fontcolor = darkslategray,
        shape = rectangle, fixedsize = false, width = 2,
        style = filled, fillcolor = AliceBlue]
a [label = '@@1']
b [label = '@@2']
c [label = '@@3']
d [label = '@@4']
e [label = '@@5']
f [label = '@@6']
g [label = '@@7']
h [label = '@@8']
i [label = '@@9']
j [label = '@@10']
k [label = '@@11']
l [label = '@@12']
m [label = '@@13']

a -> b;
a -> c -> d -> f;
c -> e -> f -> g -> m;
f -> h -> i -> m;
h -> j -> k -> m;
j -> l;

}

[1]: paste0('Number children with symptoms suggestive of TB (n = ', data$a, ')')
[2]: paste0('Presence of danger signs requiring urgent medical care (n = ', data$b, ')')
[3]: paste0('No danger signs (n = ', data$c, ')')
[4]: paste0('High risk (n = ', data$d, ')')
[5]: paste0('Low risk (n = ', data$e, ')')
[6]: paste0('Respiratory/stool/urine sample collected for mWRD (n = ', data$f, ')')
[7]: paste0('mWRD detected Mycobacterium tuberculosis (n = ', data$g, ')')
[8]: paste0('mWRD did not detect Mycobacterium tuberculosis (or not done) (n = ', data$h, ')')
[9]: paste0('Close or household TB contact in previous 12 months (n = ', data$i, ')')
[10]: paste0('No TB contact in last 12 months (n = ', data$j, ')')
[11]: paste0('Sum A + Sum B > 10 (n = ', data$k, ')')
[12]: paste0('Sum A + Sum B ≤ 10 (n = ', data$l, ')')
[13]: paste0('Appropriate TB treatment initiated (n = ', data$m, ')')
")

```

```{r, include=FALSE}
rm(a,b,c,d,e,f,g,h,i,j,k,l,m)
```

**HIV**

```{r}
# Prep data for flow chart 
library(dplyr)
library(tidyverse)

a <- subset(hiv_sub10, !is.na("PersID")) %>% summarise(a = n()) 
b <- subset(hiv_sub10, dangersigns == "Yes") %>% summarise(b = n())
c <- subset(hiv_sub10, dangersigns == "No") %>% summarise(c = n())
d <- subset(hiv_sub10, highrisk == "Yes" & dangersigns == "No") %>% summarise(d = n())
e <- subset(hiv_sub10, highrisk == "No" & dangersigns == "No") %>% summarise(e = n())
f <- subset(hiv_sub10, (sample == "Yes" | is.na(sample)) & dangersigns == "No") %>% summarise(f = n())
g <- subset(hiv_sub10, MTb_result == "MTB Positive" & dangersigns == "No") %>% summarise(g = n())
h <- subset(hiv_sub10, (MTb_result == "MTB Negative" | is.na(MTb_result)) & dangersigns == "No") %>% summarise(h = n())
i <- subset(hiv_sub10, TBContact == "Yes" & (MTb_result == "MTB Negative" | is.na(MTb_result)) & dangersigns == "No") %>% summarise(i = n())
j <- subset(hiv_sub10, TBContact == "No" & (MTb_result == "MTB Negative" | is.na(MTb_result)) & dangersigns == "No") %>% summarise(j = n())
k <- subset(hiv_sub10, Sum_B >= 10 & (MTb_result == "MTB Negative" | is.na(MTb_result)) & TBContact == "No" & dangersigns == "No") %>% summarise(k = n())
l <- subset(hiv_sub10, Sum_B < 10 & (MTb_result == "MTB Negative" | is.na(MTb_result)) & TBContact == "No" & dangersigns == "No") %>% summarise(l = n())
m <- subset(hiv_sub10, TxInitiation_B == "Yes" & dangersigns == "No") %>% summarise(m = n())

```

```{r}
library(consort)
library(labelled)
library(DiagrammeR)

# Define some sample data
data <- list(a=a$a, b=b$b, c=c$c, d=d$d, e=e$e, f=f$f, g=g$g, h=h$h, i=i$i, j=j$j, k=k$k, l=l$l, m=m$m)

DiagrammeR::grViz("
digraph graph_eos {

graph [layout = dot]

# node definitions with substituted label text
node [fontname = Helvetica, fontcolor = darkslategray,
        shape = rectangle, fixedsize = false, width = 2,
        style = filled, fillcolor = AliceBlue]
a [label = '@@1']
b [label = '@@2']
c [label = '@@3']
d [label = '@@4']
e [label = '@@5']
f [label = '@@6']
g [label = '@@7']
h [label = '@@8']
i [label = '@@9']
j [label = '@@10']
k [label = '@@11']
l [label = '@@12']
m [label = '@@13']

a -> b;
a -> c -> d -> f;
c -> e -> f -> g -> m;
f -> h -> i -> m;
h -> j -> k -> m;
j -> l;

}

[1]: paste0('Number children with symptoms suggestive of TB (n = ', data$a, ')')
[2]: paste0('Presence of danger signs requiring urgent medical care (n = ', data$b, ')')
[3]: paste0('No danger signs (n = ', data$c, ')')
[4]: paste0('High risk (n = ', data$d, ')')
[5]: paste0('Low risk (n = ', data$e, ')')
[6]: paste0('Respiratory/stool/urine sample collected for mWRD (n = ', data$f, ')')
[7]: paste0('mWRD detected Mycobacterium tuberculosis (n = ', data$g, ')')
[8]: paste0('mWRD did not detect Mycobacterium tuberculosis (or not done) (n = ', data$h, ')')
[9]: paste0('Close or household TB contact in previous 12 months (n = ', data$i, ')')
[10]: paste0('No TB contact in last 12 months (n = ', data$j, ')')
[11]: paste0('Sum A + Sum B > 10 (n = ', data$k, ')')
[12]: paste0('Sum A + Sum B ≤ 10 (n = ', data$l, ')')
[13]: paste0('Appropriate TB treatment initiated (n = ', data$m, ')')
")

```

```{r, include=FALSE}
rm(a,b,c,d,e,f,g,h,i,j,k,l,m)
```

### Supplemental Table 6:  Cohort characteristics by true or false positivity and negativity using TDA A and TDA B against the CRS

```{r}
sub10 <- sub10 %>% mutate(
  DiagnAcc_A = if_else(CRS==1 & TxInitiation=="Yes", "TP",
                       if_else(CRS==1 & TxInitiation=="No", "FN",
                               if_else(CRS==0 & TxInitiation=="Yes", "FP", "TN"))),
  DiagnAcc_A = factor(DiagnAcc_A, levels = c("TP", "FN", "FP", "TN")),
  
  DiagnAcc_B = if_else(CRS==1 & TxInitiation_B=="Yes", "TP",
                       if_else(CRS==1 & TxInitiation_B=="No", "FN",
                               if_else(CRS==0 & TxInitiation_B=="Yes", "FP", "TN"))),
  DiagnAcc_B = factor(DiagnAcc_B, levels = c("TP", "FN", "FP", "TN"))
)
```


```{r}
# TDA A
sub10 %>%
  dplyr::rename("Study" = study,
                "Age (categories)" = age_cat_ext2,
                "HIV status" = hivstatus,
                "Severe acute malnutrition" = sam) %>%
  Gmisc::getDescriptionStatsBy("Age (categories)",
                               "HIV status",
                               "Severe acute malnutrition",
                               "Study",
                               by = "DiagnAcc_A", add_total_col = FALSE, hrzl_prop = TRUE,
                               show_all_values = TRUE,
                               continuous_fn = describeMedian,
                               header_count = TRUE) %>%
  htmlTable::htmlTable(caption = "Sociodemographic characteristics by study",
                       align = "center", width = "100%") %>%
  addHtmlTableStyle(css.cell = "padding-left: .9em; padding-right: .9em;",
                    css.header = "font-weight: normal")
```

```{r}
# TDA B

sub10 %>%
  dplyr::rename("Study" = study,
                "Age (categories)" = age_cat_ext2,
                "HIV status" = hivstatus,
                "Severe acute malnutrition" = sam) %>%
  Gmisc::getDescriptionStatsBy("Age (categories)",
                               "HIV status",
                               "Severe acute malnutrition",
                               "Study",
                               by = "DiagnAcc_B", add_total_col = FALSE, hrzl_prop = TRUE, 
                               show_all_values = TRUE,
                               continuous_fn = describeMedian,
                               header_count = TRUE) %>%
  htmlTable::htmlTable(caption = "Sociodemographic characteristics by study",
                       align = "center", width = "100%") %>%
  addHtmlTableStyle(css.cell = "padding-left: .9em; padding-right: .9em;",
                    css.header = "font-weight: normal")
```


1. TDA A: Diagnostic classification

``` {r}
library(colorspace)

pdf("/Users/lshlf15/Desktop/Decide-TB_Raincloud_Diagn_TDA-A.pdf", width = 11)
sub10 %>% 
  group_by(DiagnClass_TDA) %>% 
  ggplot(aes(x = fct_rev(DiagnClass_TDA), y = Sum)) + 
  ggdist::stat_halfeye(
    aes(color = DiagnClass_TDA,
        fill = after_scale(lighten(color, .5))),
    adjust = .4, 
    width = .5, 
    .width = 0,
    justification = -.4, 
    point_color = NA) +
  geom_point(
    aes(color = DiagnClass_TDA,
        color = after_scale(darken(color, .1, space = "HLS"))),
    fill = "white",
    shape = 21,
    stroke = .4,
    size = 2,
    position = position_jitter(seed = 1, width = .12)
  ) + 
  geom_point(
    aes(fill = DiagnClass_TDA),
    color = "transparent",
    shape = 21,
    stroke = .4,
    size = 1,
    alpha = .2,
    position = position_jitter(seed = 1, width = .12)
  ) +
  geom_boxplot(
    aes(color = DiagnClass_TDA,
        color = after_scale(darken(color, .1, space = "HLS")),
        fill = after_scale(desaturate(lighten(color, .8), .4))),
    width = .22, 
    outlier.shape = NA
  ) +
  scale_color_manual(values = pal_union, guide = "none") +
  scale_fill_manual(values = pal_union, guide = "none") +
  labs(
    x = NULL,
    y = "Score",
    title = "Distribution of overall sum (Sum A + Sum B) by diagnostic classification",
  ) + 
  coord_flip(xlim = c(1.2, NA), clip = "off") +
  annotate("text", x=2.5, y=-4.5, label= "*", color="white") +
  stat_summary(
    geom = "text",    
    fun.data = add_sample,
    aes(label = paste("n =", ..label..),
        color = DiagnClass_TDA,
        color = after_scale(darken(color, .1, space = "HLS"))),
    family = "Helvetica",
    size = 6,
    hjust = 1,
    vjust = 3
  ) + 
  stat_summary(
    geom = "text",
    fun = "median",
    aes(label = round(..y.., 2),
        color = DiagnClass_TDA,
        color = after_scale(darken(color, .1, space = "HLS"))),
    family = "Helvetica",
    fontface = "bold",
    size = 6,
    vjust = -2.5
  ) +
  theme(axis.title.x = element_text(size = 14),
        axis.text.x = element_text(size = 13),  
        axis.text.y = element_text(size = 13))
dev.off()
```

2. TDA B: Diagnostic classification

``` {r}
library(colorspace)

pdf("/Users/lshlf15/Desktop/Decide-TB_Raincloud_Diagn_TDA-B.pdf", width = 11)
sub10 %>% 
  group_by(DiagnClass_TDA) %>% 
  ggplot(aes(x = fct_rev(DiagnClass_TDA), y = Sum_B)) + 
  ggdist::stat_halfeye(
    aes(color = DiagnClass_TDA,
        fill = after_scale(lighten(color, .5))),
    adjust = .4, 
    width = .5, 
    .width = 0,
    justification = -.4, 
    point_color = NA) +
  geom_point(
    aes(color = DiagnClass_TDA,
        color = after_scale(darken(color, .1, space = "HLS"))),
    fill = "white",
    shape = 21,
    stroke = .4,
    size = 2,
    position = position_jitter(seed = 1, width = .12)
  ) + 
  geom_point(
    aes(fill = DiagnClass_TDA),
    color = "transparent",
    shape = 21,
    stroke = .4,
    size = 1,
    alpha = .2,
    position = position_jitter(seed = 1, width = .12)
  ) +
  geom_boxplot(
    aes(color = DiagnClass_TDA,
        color = after_scale(darken(color, .1, space = "HLS")),
        fill = after_scale(desaturate(lighten(color, .8), .4))),
    width = .22, 
    outlier.shape = NA
  ) +
  scale_color_manual(values = pal_union_b, guide = "none") +
  scale_fill_manual(values = pal_union_b, guide = "none") +
  labs(
    x = NULL,
    y = "Score",
    title = "Distribution of overall sum by diagnostic classification",
  ) + 
  coord_flip(xlim = c(1.2, NA), clip = "off") +
  annotate("text", x=2.5, y=-4.5, label= "*", color="white") +
  stat_summary(
    geom = "text",    
    fun.data = add_sample,
    aes(label = paste("n =", ..label..),
        color = DiagnClass_TDA,
        color = after_scale(darken(color, .1, space = "HLS"))),
    family = "Helvetica",
    size = 6,
    hjust = 1,
    vjust = 3
  ) + 
  stat_summary(
    geom = "text",
    fun = "median",
    aes(label = round(..y.., 2),
        color = DiagnClass_TDA,
        color = after_scale(darken(color, .1, space = "HLS"))),
    family = "Helvetica",
    fontface = "bold",
    size = 6,
    vjust = -2.5
  ) +
  theme(axis.title.x = element_text(size = 14),
        axis.text.x = element_text(size = 13),  
        axis.text.y = element_text(size = 13))
dev.off()
```



















### Review

