---
title: "Decide-TB"
author: "Leyla Sophie Larsson"
date: '`r Sys.Date()`'
output:
  html_document:
    toc: true
    toc_depth: 2
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning=FALSE, fig.align = 'center')
# chunk options https://yihui.org/knitr/options/
```

```{r clear, include=FALSE}
rm(list = ls())
```

```{r rstan_options(auto_write = TRUE), include=FALSE}
# Import libraries

library(haven)
library(labelled)
library(foreign)
library(sjlabelled)
library(gtsummary)
library(naniar)
library(lubridate)
library(lisa)
library(ggpubr)
library(gt)
library(knitr)
library(tidyverse)
library(ggplot2)
library(ggforce)
library(ggdist)
library(gghalves)
library(magrittr)
library(multipanelfigure)
library(RColorBrewer)

theme_set(theme_light(base_size = 9))
```

```{r macros}
# Directories
projdir <- "/users/leylasophielarsson/Desktop/Studies/Decide-TB/Analysis/Code/TDA/RaPaed/SAM/"
datadir <- "/users/leylasophielarsson/Desktop/Studies/Decide-TB/Analysis/Data/"
setwd(datadir)
# Standard settings
dotsize <- 0.4 # Set dot size

```

### Aim

The aim of this file is to manipulate the available data to fit the variables we need to have per person to run through the TB-Speed SAM algorithm. 
![SAM treatment decision algorithm](SAM_algorithm.png)
#### RaPaed

```{r, include=FALSE}
# Import data
rapaed <- read_dta(paste0(datadir, "Der01_RefStandard_all.dta"))
rapaed_tblab <- read_dta(paste0(datadir, "DerA04_TbLabs.dta"))

# Unlabel
# This is useful for sorting this out https://www.pipinghotdata.com/posts/2020-12-23-leveraging-labelled-data-in-r/
rapaed <- rapaed %>%
    mutate_if(haven::is.labelled, haven::as_factor)
rapaed_tblab <- rapaed_tblab %>%
    mutate_if(haven::is.labelled, haven::as_factor)
```

```{r cr_dictionaries}

## Make a dictionary for each of the dataframes so its searchable
dict_rapaed <- labelled::generate_dictionary(rapaed) %>% 
    rename("variable_orig" = variable)
dict_rapaed_tblab <- labelled::generate_dictionary(rapaed_tblab) %>% 
    rename("variable_orig" = variable)

```

```{r}
# Some variables are stored as characters so make sure to switch the ones used for the analysis to numeric
names <- c("rapaed", "rapaed_tblab")

for (i in names) {
  assign(i, type.convert(get(i), as.is = TRUE))
}
```

This is generating the TB Labs MAX result

```{r}
# Generate an overall TB lab result before collapsing 
library(dplyr)

# Define the order of diagnostic test results
result_order <- c("Not done","Trace", "Very low", "Low", "Medium", "High")

rapaed <- rapaed %>% mutate(PCR_Semiquant = case_when(
  Xpert_quant_pp == "1. Trace" ~ "Trace",
  Xpert_quant_pp == "2. Very Low" ~ "Very low",
  Xpert_quant_pp == "3. Low" ~ "Low",
  Xpert_quant_pp == "4. Medium" ~ "Medium",
  Xpert_quant_pp == "5. High" ~ "High"
))

# Convert the DiagnosticResult column to an ordered factor
rapaed$PCR_Semiquant[is.na(rapaed$PCR_Semiquant)] <- "Not done"
rapaed$PCR_Semiquant <- factor(rapaed$PCR_Semiquant, levels = result_order, ordered = TRUE)

```

```{r}
# Generate a binary variable 
rapaed <- rapaed %>% mutate(BinaryMaxResult = if_else(Xpert_pp==3,  "MTB Positive", "MTB Negative"))
var_label(rapaed$BinaryMaxResult) <- "PCR result, binary"
```

This is generating the TB Labs first result

```{r}
# Generate a binary variable 
rapaed <- rapaed %>% mutate(BinaryFirstResult = if_else(FirstSample_Ultra_Resp==1,  "MTB Positive", "MTB Negative"))
var_label(rapaed$BinaryFirstResult) <- "PCR result, binary"
```

**SAM**

```{r, include=TRUE}
# Age (continuous but the range is from 0 to 5 years)
var_label(rapaed$age) <- "Age"

# Age (categorized from < 2 and 2 - 10 years)
rapaed$age_cat <- cut(rapaed$age,
                 breaks=c(0,2,5,10,15),
                 labels=c('< 2 years', '2 - 5 years', '5 - 10 years', '> 10 years'))
var_label(rapaed$age_cat) <- "Age, categories"
```

```{r}
# History of a contact with a TB case
rapaed <- rapaed %>% mutate(TBcontact = if_else(Q_301_Qes == "1. Yes",  "Yes", "No"))
var_label(rapaed$TBcontact) <- "History of a contact with a TB case?"

# Score: History of a contact with a TB case
rapaed <- rapaed %>% mutate(TBcontact_Score = if_else(TBcontact == "Yes",  8, 0))
var_label(rapaed$TBcontact_Score) <- "History of a contact with a TB case? -- score"
```

```{r}
# Detailed assessment of symptoms -- no loss of appetite
# Overall HIV status
rapaed$hivstatus <- rapaed$HIVstatus_bin 
var_label(rapaed$hivstatus) <- "Overall HIV status - tested and reported"

rapaed <- rapaed %>% mutate(hivstatus_Score = if_else(hivstatus == "HIV positive",  6, 0))
var_label(rapaed$hivstatus_Score) <- "HIV status -- score"

# Cough ≥ 3 weeks 
rapaed <- rapaed %>% mutate(cough_3weeks = if_else(cough_at_V1 == 1 & CoughDurDays >= 21,  "Yes", "No"))
var_label(rapaed$cough_3weeks) <- "Cough more than 3 weeks?"

rapaed <- rapaed %>% mutate(cough_3weeks_Score = if_else(cough_3weeks == "Yes",  6, 0))
var_label(rapaed$cough_3weeks_Score) <- "Cough ≥ 3 weeks  -- score"

# Temperature > 38 degrees
rapaed <- rapaed %>% mutate(Temp38 = if_else(Q_206b_Exm > 38,  "Yes", "No"))
var_label(rapaed$Temp38) <- "Temperature > 38 degrees?"

rapaed <- rapaed %>% mutate(Temp38_Score = if_else(Temp38 == "Yes",  2, 0))
var_label(rapaed$Temp38_Score) <- "Temperature > 38 degrees -- score"

# Tachycardia 
rapaed <- rapaed %>% mutate(tachycardia = case_when(
        Q_203b_Exm > 160 & age_cat_ext == "< 2 months" ~ "Yes",
        Q_203b_Exm > 150 & age >= 0.1667 & age < 1 ~ "Yes",
        Q_203b_Exm > 140 & age >= 1 & age < 5 ~ "Yes",
        Q_203b_Exm > 120 & age > 5 ~ "Yes"))
var_label(rapaed$tachycardia) <- "Tachycardia?"

rapaed <- rapaed %>% mutate(tachycardia_Score = if_else(tachycardia == "Yes", 5, 0))
var_label(rapaed$tachycardia_Score) <- "Tachycardia -- score"

# Chest indrawing 
rapaed <- rapaed %>% mutate(ChestIndrawing = if_else(Q_205bDum1_Exm == "1. Subcostal indrawings",  "Yes", "No"))
var_label(rapaed$ChestIndrawing) <- "Chest indrawing ?"

rapaed <- rapaed %>% mutate(ChestIndrawing_Score = if_else(ChestIndrawing == "Yes", 8, 0))
var_label(rapaed$ChestIndrawing_Score) <- "Chest indrawing  -- score"

# Lack of consciousness
rapaed <- rapaed %>% mutate(LackConsciousness = if_else(Q_305b1_Exm == "1. Abnormal/Yes",  "Yes", "No"))
var_label(rapaed$LackConsciousness) <- "Lack of consciousness?"

rapaed <- rapaed %>% mutate(LackConsciousness_Score = if_else(LackConsciousness == "Yes", 2, 0))
var_label(rapaed$LackConsciousness_Score) <- "Lack of consciousness -- score"

# Cervical adenopathy
rapaed <- rapaed %>% mutate(Adenopathy = if_else(Q_304b1_Exm == "3. Cervical",  "Yes", "No"))
var_label(rapaed$Adenopathy) <- "Cervical adenopathy?"

rapaed <- rapaed %>% mutate(Adenopathy_Score = if_else(Adenopathy == "Yes", 12, 0))
var_label(rapaed$Adenopathy_Score) <- "Cervical adenopathy -- score"

# Dont have loss of appetite or supraclavicular adenopathy (only cervical)

# Replace all to zero if missing. 
for (col in c("Adenopathy_Score", "LackConsciousness_Score", "ChestIndrawing_Score","tachycardia_Score","Temp38_Score","cough_3weeks_Score","hivstatus_Score")) {
  rapaed[is.na(rapaed[, col]), col] <- 0
}
```

```{r}
# Score calculations
rapaed <- rapaed %>% mutate(Symp_Score = hivstatus_Score + cough_3weeks_Score + Temp38_Score + tachycardia_Score + ChestIndrawing_Score + LackConsciousness_Score + Adenopathy_Score)
var_label(rapaed$Symp_Score) <- "Score of the signs and symptoms"

# Score cutoff 
rapaed <- rapaed %>% mutate(Symp_Score_Bin = case_when(
        Symp_Score > 10  ~ "Yes",
        Symp_Score <= 10 ~ "No" ))
var_label(rapaed$Symp_Score_Bin) <- "Score of the signs and symptoms, binary"
```

```{r}
# Chest radiograph (don't have pericardial)
# Enlarged lymph nodes
rapaed <- rapaed %>% mutate(CXR_lymph = if_else(Q_303d_Xry == "1. Yes" | Q_203d_Xry == "1. Yes" | Q_103d_Xry == "1. Yes",6,0))
var_label(rapaed$CXR_lymph) <- "Did the chest X-ray show signs of lymphadenopathy?"

# Opacities
rapaed <- rapaed %>% mutate(CXR_opacity = if_else(Q_103a_Xry == "1. Yes" | Q_203a_Xry == "1. Yes" | Q_303a_Xry == "1. Yes" | Q_103b_Xry == "1. Yes" | Q_203b_Xry == "1. Yes" | Q_303b_Xry == "1. Yes",4,0))
var_label(rapaed$CXR_opacity) <- "Did the chest X-ray show signs of opacities?"

# Effusion
rapaed <- rapaed %>% mutate(CXR_effusion = if_else(Q_303c_Xry == "1. Yes" | Q_203c_Xry == "1. Yes" | Q_103c_Xry == "1. Yes",13,0))
var_label(rapaed$CXR_effusion) <- "Did the chest X-ray show signs of pleural effusion?"

# Replace all to zero if missing. 
for (col in c("CXR_effusion", "CXR_lymph", "CXR_opacity")) {
  rapaed[is.na(rapaed[, col]), col] <- 0
}
```

```{r}
# Xpert
# What is the Xpert result?
rapaed <- rapaed %>% mutate(MTb_result_max = if_else(BinaryMaxResult == "MTB Positive",  "MTB Positive", "MTB Negative"))
var_label(rapaed$MTb_result_max) <- "What is the Mtb Xpert result?"

rapaed <- rapaed %>% mutate(MTb_result_max_Score = if_else(MTb_result_max == "MTB Positive", 40, 0))
var_label(rapaed$MTb_result_max_Score) <- "Mtb result max -- score"

rapaed <- rapaed %>% mutate(MTb_result_first = if_else(BinaryFirstResult == "MTB Positive",  "MTB Positive", "MTB Negative"))
var_label(rapaed$MTb_result_first) <- "What is the Mtb Xpert result?"

rapaed <- rapaed %>% mutate(MTb_result_first_Score = if_else(MTb_result_first == "MTB Positive", 40, 0))
var_label(rapaed$MTb_result_first_Score) <- "Mtb result first -- score"

```

```{r}
# Nothing abdominal US
```

```{r}
# Score calculations
rapaed <- rapaed %>% mutate(Overall_Score_max = MTb_result_max_Score + CXR_lymph + CXR_opacity + CXR_effusion)
var_label(rapaed$Overall_Score_max) <- "Overall score"

# Score cutoff 
rapaed <- rapaed %>% mutate(Tx_Initiation_max = case_when(
        Overall_Score_max > 10  ~ "Initiate treatment",
        Overall_Score_max <= 10 ~"No treatment initiation"))
var_label(rapaed$Tx_Initiation_max) <- "Treatment initiation"

# Score calculations
rapaed <- rapaed %>% mutate(Overall_Score_first = MTb_result_first_Score + CXR_lymph + CXR_opacity + CXR_effusion)
var_label(rapaed$Overall_Score_first) <- "Overall score"

# Score cutoff 
rapaed <- rapaed %>% mutate(Tx_Initiation_first = case_when(
        Overall_Score_first > 10  ~ "Initiate treatment",
        Overall_Score_first <= 10 ~"No treatment initiation"))
var_label(rapaed$Tx_Initiation_first) <- "Treatment initiation"
```

```{r}
tbspeed_sam <- rapaed
var_label(tbspeed_sam$PersID) <- "Participant ID"

dict_tbspeed_sam <- labelled::generate_dictionary(tbspeed_sam) %>% 
    rename("variable_orig" = variable)
```

```{r}
# Add unclassifiable label to DiagnClass
tbspeed_sam <- tbspeed_sam %>% mutate(DiagnClass = if_else(is.na(DiagnClass),"Unclassifiable",DiagnClass))
```

```{r}
# Save for later use
save(tbspeed_sam,file="/Users/leylasophielarsson/Desktop/Studies/Decide-TB/Analysis/Data/Decide-TB_SAM_Dataset.Rda")
save(dict_tbspeed_sam,file="/Users/leylasophielarsson/Desktop/Studies/Decide-TB/Analysis/Data/Decide-TB_SAM_Dict.Rda")

```











